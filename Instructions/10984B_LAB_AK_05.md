# Lab Answer Key:  Module 5: Skype for Business and Teams in Office 365 hybrid deployment
# Lab: Implement the Skype for Business hybrid configuration

## Exercise 1: Deploy Skype for Business Server and Skype for Business Edge Server (pre-lab)

#### Task 1: Prepare the environment (these steps have already been done for you)

> **Note:** To save time, the steps in Task 1 and Task 2 have been completed for you. They are provided here for your information and future reference. You can proceed directly to **Task 3: Update Topology** to start this lab.

1. Sign in to **LON-SFB** as **Administrator@adatum.com** with the password **Pa55w.rd**.
2. On the taskbar, select **Skype for Business Server Management Shell**.
3. Create a share for **LON-SFB** by running the following two commands:

    ```
    New-Item C:\SkypeShare -Type Directory
    ```

    ```
    New-SmbShare -Name SkypeShare -Path C:\SkypeShare -FullAccess "Domain Admins","Administrators"
    ```

4. Open File Explorer.
5. Browse to **D:\OCS_Eval\Setup\amd64**, and then double-click **Setup.exe**.
6. If prompted, select **OK** to install Microsoft Visual C++ 2013 Redistributable (x64 runtime).
7. Confirm that the install location is **C:\Program Files\Skype for Business Server 2019**, and then select **OK** to continue and install the core components.
8. In the **Deployment Wizard** window, select **Install Administrative Tools**.
9. On the **Install Administrative Tools** page, select **Next**.
10. On the **Executing Commands** page, wait for the **Completed** status, and then select **Finish**.
11. In the **Deployment Wizard** window, select **Prepare Active Directory**, and then select **Run on Prepare Schema**.
12. Select **Prepare Current Forest**.
13. On the **Universal Group Location** page, select **Local domain**, and then select **Next**.
14. On the **Executing Commands** page, wait for the **Completed** status to appear, and then select **Finish**.
15. On the **Active Directory preparation** page, in the **Prepare Current Domain** step, select **Run**.
16. On the **Prepare Domain** page, select **Next**.
17. On the **Executing Commands** page, wait for the **Completed** status to appear, and then select **Finish**.
18. In the **Deployment Wizard** window, select **Back**.
19. On the main **Deploy** page, select **Prepare first Standard Edition server**.
20. On the **Prepare single Standard Edition Server** page, select **Next**.
21. On the **Executing Commands** page, wait for the **Completed** status to display, and then select **Finish**.
22. Right-click **Start**, and then select **Run**.
23. In the **Open** box, enter **dsa.msc**, and then select **OK**.
24. In the **Active Directory Users and computers** window, expand **Adatum.com**, select **Users**, and then double-click **CSAdministrator**.
25. In the **CSAdministrator Properties** window, select **Members**, and then select **Add**.
26. In the **Select users, Contacts, Computes, Service Accounts or Groups** dialog box, in the **Enter the object names to select files** box, enter **Administrator**, and then select **OK** twice.
27. Repeat Steps 23-26 for the **RTCUniversalServerAdmins security** group.
28. Close the **ADUC** window.
29. To apply the new permission, select **Start**, **Shutdown or sign out**, and then select **Sign out**.
30. Sign back in as **Adatum\Administrator** with the password **Pa55w.rd**.
31. Right-click **Start**, and then select **Run**.
32. In the **Open** box, enter **cmd.exe**, and then select **OK**.
33. Run the following commands to confirm that correct permissions have been applied:

    ```
    whoami /groups /fo list | findstr /i CsAdmin 
    ```

    ```
    whoami /groups /fo list | findstr /i RTC
    ```


#### Task 2: Define topology (these steps have already been done for you)

> **Note:** To save time, the steps in Task 1 and Task 2 have been completed for you. They are provided here for your information and future reference. You can proceed directly to **Task 3: Update Topology** to start this lab.

1. Sign in to **LON-SFB** as **Administrator@adatum.com** with the password **Pa55w.rd**.
2. On the taskbar, select **Skype for Business Server Topology Builder**.
3. In the **Topology Builder** window, select **New Topology**, and then select **OK**.
4. Browse to **C:\Labfiles\Mod05**, enter **Lab5.tbxml**, and then select **Save**.
5. In the **Create New Topology Wizard**, on the **Define the primary domain** page, enter **adatumyyxxxxx.hostdomain.com**, and then select **Next**.
6. On the **Specify additional supported domains** page, select **Next**.
7. On the **Define the first site** page, in the **Name** box, enter **Adatum**, and then select **Next**.
8. On the **Specify site details** page, in the **City** box, enter **London**, in the **State/Province** box, enter **England**, in the **Country/Region Code** box, enter **UK**, and then select **Next**.
9. On the **New topology was successfully defined** page, ensure that **Open the New Front End Wizard when this wizard closes** is selected, and then select **Finish**.
10. In the **Define New Front End Pool Wizard**, on the **Define the New Front End pool** page, select **Next**.
11. On the **Define the Front End pool FQDN** page, in the **FQDN** box, enter **lon-sfb.adatum.com**, select **Standard Edition Server**, and then select **Next**.
12. On the **Select Features** page, select the **Conferencing** check box, select the **Enterprise Voice** check box, and then select **Next**.
13. On the **Select collocated server roles** page, verify that **Collocate Mediation Server** is selected, and then select **Next**.
14. On the **Associate server roles with this Front End Pool** page, select the **Enable an Edge pool to be used by the media component of this Front End pool** check box, and then select **Next**.
15. On the **Select an Edge Server** page, select **New**.
16. In the **Define New Edge Pool Wizard**, on the **Define the New Edge Pool** page, select **Next**.
17. On the **Define the Edge pool FQDN** page, in the **Pool FQDN** box, enter **lon-edge.adatum.com**. Select **This pool has one server**, and then select **Next**.
18. On the **Enable Federation** page, select the **Enable federation (Port 5061)** check box, ensure all the other check boxes are cleared, and then select **Next**.
19. On the **Select Features** page, select the **Use a single FQDN and IP address** check box, and then select **Next**.
20. On the **Select IP options** page, ensure that both the **Enable IPv4 on internal interface** and the **Enable IPv4 on external interface** check boxes are selected and all other check boxes are cleared, and then select **Next**.
21. On the **External FQDNs** page, in the **Access Edge service** box, enter **access.adatumyyxxxxx.hostdomain.com**. Review the ports that are assigned to other services, and then select **Next**.
22. On the **Define the internal IP address** page, in the **Internal IPv4 address** box, enter **10.0.0.10**, and then select **Next**.
23. On the **Define the external IP address** page, in the **External IPv4 address** box, enter **172.16.0.16**, and then select **Next**.
24. On the **Define the next top server** page, verify that **lon-sfb.adatum.com Adatum** is selected, and then select **Finish**.
25. In the **Define New Front End Pool Wizard**, on the **Select and Edge Server** page, verify that **lon-edge.adatum.com Adatum** is selected, and then select **Next**.
26. On the **Define the SQL Server store** page, leave the default settings, and then select **Next**.
27. On the **Define the File Store** page, verify that **Define a new file store** is selected and **lon-sfb.adatum.com** is listed as the **File server FQDN**, change **File share** to **SkypeShare**, and then select **Next**.
28. On the **Specify the Web Services URL** page, change the **External Base URL** string to **web-ext.adatumyyxxxxx.hostdomain.com**, and then select **Next**.
29. On the **Select an Office Web Apps Server** page, clear the **Associate pool with an Office Web Apps Server** check box, and then select **Finish**.
30. In the **Skype for Business Server 2019 Topology Builder** window, expand the **Adatum** site, expand **Skype for Business Server 2019**, expand **Mediation pools**, right-click **lon-sfb.adatum.com**, and then select **Edit Properties**.
31. In the **Edit Properties** window, under **Mediation server PSTN gateway**, select the **Enable TCP port** check box, and then select **OK**.
32. In the **Skype for Business Server 2019 Topology Builder** window, expand **Shared Components**, right-click **PSTN gateways**, and then select **New IP/PSTN Gateway**.
33. In the **Define New IP/PSTN Gateway Wizard**, on the **Define the PSTN Gateway FQDN** page, in the **FQDN** box, enter **172.16.0.210**, and then select **Next**.
34. On the **Define the IP address** page, leave the default settings, and then select **Next**.
35. On the **Define the root trunk** page, enter the following settings, and then select **Finish**:

  - Trunk Name: **IP-PBX**
  - Listening port for the IP/PSTN gateway: **5060**
  - SIP Transport Protocol: **TCP**
  - Associated Mediation Server: **lon-sfb.adatum.com  Adatum**
  - Associated Mediation Server port: **5068**

    > **Note:** The Associated Mediation Server port will change automatically from 5067 to 5068 after you change the SIP Transport Protocol from TLS to TCP.
    > If you have not enabled TCP ports on the Mediation Server, you will not be able to configure an IP Gateway/Trunk to use the TCP port.

36. In the **Skype for Business Server 2019 Topology Builder** window, right-click the **Skype for Business Server** container, and then select **Edit Properties**.
37. In the **Edit Properties** window, in the left navigation pane, select **SIP domain**, and then verify that the sip domain matches your assigned public domain. For example: **adatumyyxxxxx.hostdomain.com**
38. Scroll down to the **Simple URLs** section. Review the **Phone access URLs** and **Meeting URLs**, and then in the **Administrative access URL** box, enter **https://admin.adatumyyxxxx.hostdomain.com**.
39. Scroll down to the **Central Management Server** section. Select the **Front End Server to install Central Management Server on** drop-down box, select **lon-sfb.adatum.com Adatum**, and then select **OK**.
40. Right-click **Adatum**, and then select **Edit Properties**.
41. In the left navigation pane, select **Federation route**. In the drop-down box, verify that **Enable SIP federation** and **lon-edge.adatum.com Adatum Edge** are selected, and then select **OK**.
42. Right-click **Adatum**, select **Topology**, and then select **Publish**.
43. On the **Publish the topology** page, select **Next**.
44. On the **Select Central Management Server** page, verify that **lon-sfb.adatum.com Adatum** is selected, and then select **Next**.

    > **Note:** The expected results are that all publishing steps have a **Success** status.

45. Close the **Skype for Business Server Topology Builder** window.


#### Task 3: Update the topology


1. Sign in to **LON-SFB** as **Administrator@adatum.com** with the password **Pa55w.rd**.
2. Open File Explorer.
3. Browse to **C:\Labfiles\Mod05**.
4. Right-click **Lab5.txt**, select **Open with**, and then select **Notepad**.
5. In Notepad, select the **Edit** menu, and then select **Replace**.
6. In the **Replace** window, in the **Find what** box, enter **adatumyyxxxxx.hostdomain.com**. In the **Replace with** box, enter the public domain you were assigned (for example, **AB12345.xtremelabs.us**), and then select **Replace All**.
7. Close the **Replace** window.
8. In the **Lab5.txt - Notepad** window, select the **File** menu, and then select **Save As**.
9. Save the file name as **Lab5.tbxml**, change the **Save as type** to **All files (\*.\*)**, and then select **Save**.

    > **Note:** Be careful not to leave a .txt extension on the filename.

10. When the **Confirm Save As** dialog box appears, select **Yes**.
11. Close Notepad.
12. On the taskbar, select **Skype for Business Server Topology Builder**.
13. In the **Topology Builder** window, select **Open Topology from a local file**, and then select **OK**.
14. Browse to **C:\Labfiles\Mod05**, select **Lab5.tbxml**, and then select **Open**.
15. In the **Skype for Business Server 2019 Topology Builder** window, review the following settings and verify that the domain name provided to you has been accurately applied to the topology builder file:

  - **SIP Domain**
  - **Simple URLs**
  - **Skype for Business Server** \> **Adatum** \> **Skype for Business Server 2019** \> **Standard Edition Front End Servers** \> **lon-sfb.adatum.com** \>  **External web services**
  - **Edge pools** \> **lon-edge.adatum.com** \> **External settings**

    > **Note:** The expected result is that your assigned adatumyyxxxxx.hostdomain.com has replaced the placeholder values.

    > Be aware that a Skype for Business Server 2019 Standard Edition server's internal Fully Qualified Domain Names (FQDNs) must match its Active Directory Domain (AD DS) FQDN. This is different from the Enterprise Edition pool FQDN. In this lab, that means that the pool FQDN must be **lon-sfb.adatum.com**. The internal FQDN of **LON-EDGE** is also **lon-edge.adatum.com**.

    > If you see any discrepancies or have any concerns about the settings, please let your instructor know before continuing.

    > If everything looks okay, you are ready to continue to the next step and publish the topology.

16. Right-click **Adatum**, select **Topology**, and then select **Publish**.
17. On the **Publish the topology** page, select **Next**.
18. On the **Select Central Management Server** page, verify that **lon-sfb.adatum.com Adatum** is selected, and then select **Next**.

    > **Note:** If you receive an Active Director error when publishing the topology you can safely disregard and proceed with the lab.

19. On the **Publishing wizard complete** page, select **Finish**.
20. Close the **Skype for Business Server 2019, Topology Builder** window.


#### Task 4: Install Skype for Business Server 2019


1. On **LON-SFB**, click the start menu and select **Windows PowerShell**.
2. To install the prerequisites, run the following command:

    ```
    Add-WindowsFeature RSAT-ADDS, Web-Server, Web-Static-Content, Web-Default-Doc, Web-Http-Errors, Web-Asp-Net, Web-Net-Ext, Web-ISAPI-Ext, Web-ISAPI-Filter, Web-Http-Logging, Web-Log-Libraries, Web-Request-Monitor, Web-Http-Tracing, Web-Basic-Auth, Web-Windows-Auth, Web-Client-Auth, Web-Filtering, Web-Stat-Compression, Web-Dyn-Compression, NET-WCF-HTTP-Activation45, Web-Asp-Net45, Web-Mgmt-Tools, Web-Scripting-Tools, Web-Mgmt-Compat, Windows-Identity-Foundation, Server-Media-Foundation, Telnet-Client, BITS, ManagementOData, Web-Mgmt-Console, Web-Metabase, Web-Lgcy-Mgmt-Console, Web-Lgcy-Scripting, Web-WMI, Web-Scripting-Tools, Web-Mgmt-Service
    ```

3. To restart **LON-SFB**, type **Restart-Computer** , and then press Enter. After the computer restarts, sign back in as **Adatum\Administrator** by using the password **Pa55w.rd**.
4. On **LON-SFB**, in File Explorer, navigate to **D:\OCS_Eval\Setup\amd64**, and then double-click **Setup.exe**. Wait for the Microsoft Visual C++ 2017 Redistributable (x64) install to complete.
5. On the Skype for Business Server message box, click **Don’t check for updates right now**, and then click **Install**.
6. On the End User License Agreement page, select **I accept the terms in the license agreement**, and then click **OK**.
7. On **LON-SFB**, on the Skype for Business Server 2019 - Deployment Wizard page, click **Install or Update Skype for Business Server System**.
8. On the Skype for Business Server 2019 - Deployment Wizard page, next to **Step 1: Install Local Configuration Store**, click **Run**.
9. On the Configure Local Replica of Central Management Store page, verify that **Retrieve directly from the Central Management Store** is selected, and then click **Next**. 
    
    > **Note:**This step will take about 10 minutes to execute.
10. On the Executing Commands page, when the Task Status shows **Completed**, click **Finish**.
11. On **LON-SFB**, on the Skype for Business Server 2019 - Deployment Wizard page, next to **Step 2: Setup or Remove Skype for Business Server Components**, click **Run**.
12. On the Setup Skype for Business Server Components page, click **Next**.
    
    > **Note:This step will take approximately 15 minutes to run.**
13. On the Executing Commands page, click **Finish**.
14. On **LON-SFB**, on the Skype for Business Server 2019 - Deployment Wizard page, next to **Step 3: Request, Install or Assign Certificates**, click **Run**.
15. In the Certificate Wizard window, select **Default Certificate**, and then click **Request**.
16. On the Certificate Request page, select the following options and then click **Next**:
  - In the **Select a CA from the list detected in your environment** drop-down list, verify that **LON-DC1.Adatum.com\AdatumCA** is present.
  - In the **Friendly Name** box, type **LON-SFB Skype for Business Server 2019 Default Certificate**.
  - In the **Organization** box, type **Adatum**.
  - In the **Organizational Unit** box, type **IT**.
  - In the **Country/Region** drop-down list, select **United Kingdom**.
  - In the **State/Province** box, type **England**.
  - In the **City/Locality** box, type **London**.
  - In the **Select one or more SIP Domains … to be added to the subject alternative names list**, select **All**.
17.	On the Certificate Request Summary page, click **Next**.
18.	On the Executing Commands page, when the Task Status shows **Completed**, click **Next**.

    > **Note: If the certificate request fails, check if the Active Directory Certificate Services service is running on LON-DC1. If not, start the service, and then retry the certificate request.**

19.	On the Online Certificate Request Status page, verify that **Assign this certificate to Skype for Business Server certificate usages** is selected, and then click **Finish**.
20.	On the Certificate Assignment page, click **Next**.
21.	On the Certificate Assignment Summary page, click **Next**.
22.	On the Executing Commands page, when the Task Status shows **Completed**, click **Finish**.
23.	On the Certificate Wizard, click the down arrow next to **Default Certificate** to expand the Certificate Type.
24.	Verify that **Server Default**, **Web Services Internal**, and **Web Services External** have green checkmarks next to them.
25.	In the Certificate Wizard window, select **OAuthTokenIssuer**, and then click **Request**.
26.	On the Certificate Request page, leave the default settings and  click **Next**.
27.	On the Certificate Request Summary page click **Next**.
28.	On the Executing Commands page verify the Task status is **Completed** and then click **Next**.
29.	On the Online Certificate Request Status page verify that **Assign this certificate to Skype for Business Server certificate usages** is selected and click **Finish**.
30.	On the Certificate Assignment page click **Next**.
31.	On the Certificate Assignment Summary page click **Next**.
32.	ON the Executing Commands page verify the Task status is **Completed** and click **Finish**.
33.	On the Certificate Wizard, click the down arrow next to **OAuthTokenIssuer** to expand the Certificate Type.
34.	Verify that the **OAuthTokenIssuer** has a green check mark next to it.
35.	Click **Close** to close the Certificate Wizard.
36.	On the Skype for Business Server 2019 – Deployment Wizard page, click **Exit**.


#### Task 5: Update Skype for Business Server 2019


1. On **LON-SFB**, click **Start**, expand Skype for Business Server 2019, then click **Skype for Business Server Management Shell**.
2. In the Skype for Business Management Shell run **Stop-CsWindowsService**.
3. Type **CD C:\Labfiles** and press **Enter**. 
4. In the Skype for Business Management shell run **.\SkypeServerUpdateInstaller.exe**
5. In the Skype for Business Server 2019 Update Installer window review the Installed Version vs. the Update Version for each component and then click **Install Updates**.
6. Click **No** when asked **“You must reboot this computer to complete the update process. Would you like to reboot now?”** to postpone the restart of the computer.
7. Click **Close** on the Skype for Business Server 2019 Update Installer window.

    >**Note it may be behind the Skype for Business Server Management Shell window.**

8. In Skype for Business Management Shell type **CD “C:\Program Files\Skype for Business Server 2019\Deployment”** and press **Enter**.
9. Type the following command and press Enter:

    ```
    .\Bootstrapper.exe
    ```
10. Restart the computer by typing **Restart-Computer** in the Skype for Business Management Shell and then press **Enter**.
11. When the server restarts sign back in as **Adatum\Administrator** with the password **Pa55w.rd**. Open the Skype for Business Server Management Shell.

    >**Note: Wait for the all the Skype for Business Server services to start. This could take several minutes. You can run the Get-CsWindowsService cmdlet to check the state of the services.**

12.	In the Skype for Business Management Shell type the following command to update the Skype for Business Server 2019 Standard Edition local databases and then press Enter:

    ```
    Install-CsDatabase -Update -LocalDatabases
    ```
    >**Note: Wait for the update to complete. You can safely disregard the warnings for Install-CsDatabase**

#### Task 6: Install Skype for Business Server 2019 Edge Server

1. On **LON-SFB**, in the Skype for Business Management Shell run the following commands to export the configuration and place a copy on LON-EDGE.  
    ```
    Export-CsConfiguration -FileName C:\Labfiles\Mod05\EdgeConfig.zip
    ```

    ```
    Robocopy.exe C:\Labfiles\Mod05 \\lon-edge\C$\Labfiles\Mod05\ EdgeConfig.zip
    ```
2. On **LON-EDGE**, Sign in with **Administrator** by using the password **Pa55w.rd** and then click the start menu and select **Windows PowerShell**.
3. To install the prerequisites, run the following command:

    ```
    Add-WindowsFeature RSAT-ADDS, Web-Server, Web-Static-Content, Web-Default-Doc, Web-Http-Errors, Web-Asp-Net, Web-Net-Ext, Web-ISAPI-Ext, Web-ISAPI-Filter, Web-Http-Logging, Web-Log-Libraries, Web-Request-Monitor, Web-Http-Tracing, Web-Basic-Auth, Web-Windows-Auth, Web-Client-Auth, Web-Filtering, Web-Stat-Compression, Web-Dyn-Compression, NET-WCF-HTTP-Activation45, Web-Asp-Net45, Web-Mgmt-Tools, Web-Scripting-Tools, Web-Mgmt-Compat, Windows-Identity-Foundation, Server-Media-Foundation, Telnet-Client, BITS, ManagementOData, Web-Mgmt-Console, Web-Metabase, Web-Lgcy-Mgmt-Console, Web-Lgcy-Scripting, Web-WMI, Web-Scripting-Tools, Web-Mgmt-Service
    ```

4. To restart **LON-EDGE**, type **Restart-Computer** , and then press Enter. After the computer restarts, sign back in as **Administrator** by using the password **Pa55w.rd**.
5. On **LON-EDGE**, in File Explorer, navigate to **D:\OCS_Eval\Setup\amd64**, and then double-click **Setup.exe**. Wait for the Microsoft Visual C++ 2017 Redistributable (x64) install to complete.
6. On the Skype for Business Server message box, click **Don’t check for updates right now**, and then click **Install**.
7. On the End User License Agreement page, select **I accept the terms in the license agreement**, and then click **OK**.
8. On **LON-EDGE**, on the Skype for Business Server 2019 - Deployment Wizard page, click **Install or Update Skype for Business Server System**.
9. On the Skype for Business Server 2019 - Deployment Wizard page, next to **Step 1: Install Local Configuration Store**, click **Run**.
10. On the Configure Local Replica of Central Management Store page, verify that **Import from a file (recommended for Edge Servers)** is selected, and then click **Browse**. 
11. On the Open dialog box navigate to **C:\Labfiles\Mod05**, select **EdgeConfig.zip**, and then click **Open**. 
12. On the Configure Local Replica of Central Management Store page, click **Next**.
    
    > **Note:**This step will take about 10 minutes to execute.
13. On the Executing Commands page, when the Task Status shows **Completed**, click **Finish**.
14. On **LON-EDGE**, on the Skype for Business Server 2019 - Deployment Wizard page, next to **Step 2: Setup or Remove Skype for Business Server Components**, click **Run**.
15. On the Setup Skype for Business Server Components page, click **Next**.
    
    > **Note:This step will take approximately 15 minutes to run.**
16. On the Executing Commands page, click **Finish**.
17. On the Skype for Business Server 2019 - Deployment Wizard page, click **Exit**.
    
    >**Note:** You will now obtain and assign certificates using Windows PowerShell.
18. To open Windows PowerShell, if it is not already open, click the start menu and select **Windows PowerShell**.
19. To request an internal certificate, in Windows PowerShell, type the following command and then press Enter:

    ```
    $Certificate = Request-CSCertificate -New -Type Internal -CA "LON-DC1.adatum.com\AdatumCA" -Country "GB" -State "England" -City "London" -FriendlyName "Edge Internal" -KeySize 2048 -PrivateKeyExportable $True -Organization "Adatum" -OU "IT" -CAAccount "adatum\administrator" -CAPassword "Pa55w.rd" -AllSipDomain -Verbose
    ```

    >**Note:** The **-Verbose** parameter will display the steps perfomred by the script in yellow. These are not warning or errors and can safely be ignored. 

20. To assign the internal certificate, in Windows PowerShell, type the following command and then press Enter:

    ```
    Set-CsCertificate -Thumbprint $Certificate.Thumbprint -Type Internal
    ```
21. To request an external certificate, in Windows PowerShell, type the following command and then press Enter:

    ```
    $Certificate2 = Request-CSCertificate -New -Type AccessEdgeExternal,DataEdgeExternal,AudioVideoAuthentication -CA "LON-DC1.adatum.com\AdatumCA" -Country "GB" -State "England" -City "London" -FriendlyName "Edge External" -KeySize 2048 -PrivateKeyExportable $True -Organization "Adatum" -OU "IT" -CAAccount "adatum\administrator" -CAPassword "Pa55w.rd" -AllSipDomain -Verbose 
    ```

    >**Note:** The **-Verbose** parameter will display the steps perfomred by the script in yellow. These are not warning or errors and can safely be ignored. 

22. To assign an external certificate, in Windows PowerShell, type the following command and then press Enter:

    ```
    Set-CsCertificate -Thumbprint $Certificate2.Thumbprint -Type AccessEdgeExternal,DataEdgeExternal,AudioVideoAuthentication
    ```

23. Close the PowerShell window.


#### Task 7: Update Skype for Business Edge Server


1. On **LON-EDGE**, click start menu and expand Skype for Business Server 2019 and then select **Skype for Business Server Management Shell**.
2. In the Skype for Business Management Shell run **Stop-CsWindowsService**.
3. Type CD **C:\Labfiles** and press **Enter**. 
4. In the Skype for Business Management shell run **.\SkypeServerUpdateInstaller.exe**

    > **Note:** If you receive a "Failed to run" error, try to use the SkypeServerUpdateInstaller.exe file at **\\LON-SFB\C$\Labfiles**.

5. In the Skype for Business Server 2019 Update Installer window review the Installed Version vs. the Update Version for each component and then click **Install Updates**.
6. Click **No** when asked **“You must reboot this computer to complete the update process. Would you like to reboot now?”** to postpone the restart of the computer.
7. Click **Close** on the Skype for Business Server 2019 Update Installer window.

    >**Note it may be behind the Skype for Business Server Management Shell window.**

8. In Skype for Business Management Shell type **CD “C:\Program Files\Skype for Business Server 2019\Deployment”** and press **Enter**.
9. Type the following command and press Enter:

    ```
    .\Bootstrapper.exe
    ```
10. Restart the computer by typing **Restart-Computer** in the Skype for Business Management Shell and then press **Enter**.
11. When the server restarts sign back in as **Administrator** with the password **Pa55w.rd**. Open the Skype for Business Server Management Shell.

    >**Note:** Wait for the Skype for Business Server services to start. You can run the **Get-CsWindowsService** cmdlet to check the state of the services. The **FabricHostSvc** is not expected to start at this time. You can continue the lab without this service. 


## Exercise 2: Design and implement a Skype for Business hybrid configuration

#### Task 1: Read and analyze the scenario requirements

1. Read the exercise scenario and analyze the requirements from an integration perspective.
2. Identify the configurations that are necessary to satisfy the requirements.
3. Sign in to **LON-CL1** as **Adatum\Beth** with the password **Pa55w.rd**.
4. Open File Explorer, browse to **C:\Labfiles\Mod05**, and then open **10984_Lab5_Design.pptx**.
5. In the **The fine print window**, select **Accept and start PowerPoint**.
6. Use the PowerPoint slides to help you document your design.


#### Task 2: Design and discuss a solution with the class
Use the questions below to help refine your solution.

  **Question 1**: What components do you need to install and configure to satisfy the requirements? 

  **Answer**: You need the following configurations:

  - You must use password synchronization as your password-management solution because it requires the least amount of administrative effort.
  - You must deploy an edge server and configure federation and shared namespace.
  - You must deploy an HTTP proxy.

  **Question 2**: What are the licensing requirements for Skype for Business Online? 

  **Answer**: You will need either the E5 or E3 license with the add-on for Office 365 Phone System.

  **Question 3**: When moving users to Skype for Business Online, what precautions should Adatum take based on their existing environment? 

  **Answer**: They should not move the Research department as XMPP is not supported in Skype for Business Online. They should enable users for Enterprise Voice before moving them to Skype for Business Online.

  **Question 4**: Which hybrid voice solution will work best for Adatum? 

  **Answer**: They should use Phone System with on-premises PSTN calling by using an existing Skype for Business environment.

Present your proposed solution to the class. Discuss alternative solutions with the students.



#### Task 3: Configure On-premises users

1. Sign in to **LON-SFB** as **Adatum\Administrator** with the password **Pa55w.rd**.
2. From the **Taskbar**, open **Skype for Business Server Control Panel** and sign in as **Adatum\Administrator** with the password **Pa55w.rd**.
3. In the left navigation pane, select **Users**.
4. On the **USER SEARCH** page, select **Enable users**, and under **New Skype for Business Server User**, select **Add**.
5. In the **Search** box, enter **Holly**, and then select **Find**.
6. Select **Holly Spencer**, and then select **OK**.
7. In the **Assign users to a pool** drop-down box, select **lon-sfb.adatum.com**.
8. Under **Generate user's SIP URI**, select **Use the user principal name (UPN)**.
9. In the **Telephony** drop-down box, select **Enterprise Voice**.
10. In the **Line URI** box, enter **tel:+442079312380**.
11. On the **USER SEARCH** page, select **Enable**.
12. Repeat steps 4-11 to enable the following users for Skype for Business with Enterprise Voice by using the Line URI provided for each user.

    |  **User** | **Line URI** |
    | ------------- | ------------------- |
    | Adam Hobbs | tel:+442079312341 |
    | Beth Burke | tel:+442079312335 |
    | Abbi Skinner | tel:+442079312310 |
    | Allan Yoo | tel:+442079312320 |
    | Cai Chu | tel:+442079312383 |
    | Ella Perry | tel:+442079312372 |
    | Jon Friday | tel:+442079312308 |

13. In the left navigation pane, select **Federation and External Access**, and then select the **EXTERNAL ACCESS POLICY** tab.
14. On the **EXTERNAL ACCESS POLICY** tab, review the settings for the **Global** policy. Note that there are no external access options enabled at this time.
15. Select the **ACCESS EDGE CONFIGURATION** tab and review the settings for the **Global** policy. Note that no external access options are enabled.
16. Select **SIP FEDERATED DOMAINS**, and then verify that there are no **Allowed or Blocked** domains configured.
17. Sign in to **LON-DS1** as **Adatum\Administrator** with the password **Pa55w.rd**.
18. Open Windows PowerShell.
19. In the **Windows PowerShell** window, enter the following cmdlet, and then press Enter:

    ```
    Start-ADSyncSyncCycle -PolicyType Initial
    ```


#### Task 4: Deploy a Skype for Business hybrid configuration

1. On **LON-SFB**, open File Explorer, browse to **C:\LabFiles\Mod05**, and then double-click **msoidcli_64bit.msi**.
2. Install the Microsoft Online Services Sign-in Assistant by using the default settings, and then select **Finish**.
3. On the taskbar, select **Skype for Business Server Management Shell**.
4. At the **Skype for Business Server Management Shell** command prompt, enter the following command, and then press Enter:

    ```
    Install-Module MSOnline
    ```

5. In the **NuGet provider is required to continue** box, type **Y**, and then press Enter.
6. In the **Untrusted Repository** box, type **Y**, and then press Enter.
7. At the **Skype for Business Server Management Shell** command prompt, enter the following command, and then press Enter:

    ```
    Set-CSAccessEdgeConfiguration -AllowOutsideUsers 1 -AllowFederatedUsers 1 -EnablePartnerDiscovery 1 -UseDnsSrvRouting -AllowAnonymousUsers 1
    ```

8. Enter the following command, and then press Enter:

    ```
    Set-CsExternalAccessPolicy -EnableFederationAccess 1 -EnablePublicCloudAccess 1 -EnableOutsideAccess 1
    ```

9. Enter the following command, and then press Enter:

    ```
    Get-CsHostingProvider | Remove-CsHostingProvider
    ```

    > **Note:** This will remove any existing hosting provider to create a clean environment for the lab.

10. Enter the following command, and then press Enter:

    ```
    New-CSHostingProvider -Identity Office365 -ProxyFqdn sipfed.online.lync.com -Enabled $true -EnabledSharedAddressSpace $true -HostsOCSUsers $true -VerificationLevel UseSourceVerification -IsLocal $false -AutodiscoverUrl https://webdir.online.lync.com/Autodiscover/AutodiscoverService.svc/root
    ```

11. Enter the following command, and then press Enter:

    ```
    $creds=Get-Credential
    ```

12. When prompted, enter your Office 365 lab tenant administrator account username and password. For example, Beth@adatumyyxxxxx.onmicrosoft.com.
13. Enter the following command, and then press Enter:

    ```
    Install-Module -Name MicrosoftTeams
    ```

14. Enter the following command, and then press Enter:

    ```
    Import-Module -Name MicrosoftTeams
    ```

15. Enter the following command, and then press Enter:

    ```
    Connect-MicrosoftTeams -Credential $creds
    ```

16. Enter the following command, and then press Enter:

    ```
    Set-CsTenantFederationConfiguration -SharedSipAddressSpace $True
    ```

17. Leave the **Skype for Business Server Management Shell** open.


    > **Result**: After completing this exercise, you will have successfully:

    >- Read and analyzed the scenario requirements.
    >- Designed a solution.
    >- Set up Hybrid with Office 365
    >- Prepared for migration from Skype for Business to Microsoft Teams


## Exercise 3: Move users to Skype for Business Online and Teams

#### Task 1: Move users to Skype for Business Online

1. On **LON-CL1** sign out and sign in as **Adatum\Adam** with the password **Pa55w.rd**.
2. Select **Start**, enter **Skype**, and then select **Skype for Business**.
3. If the **The fine print** window appears, select **Accept and start Skype for Business**.
4. If the Microsoft Office Activation Wizard window appears, Click **Close**.
5. Confirm that **Adam Hobbs** is signed in.
6. In the **Find** box, enter **abbi@adatumyyxxxxx.hostdomain.com**, and then confirm that **Abbi Skinner** resolves on the **MY CONTACTS** tab.
7. Right-click **Abbi Skinner**, and then select **Add to Favorites**.
8. On **LON-CL2** sign out and sign in as **Adatum\Abbi** with the password **Moc10984B**.
9.  select **Start**, enter **Skype**, and then select **Skype for Business**.
10. In the **The fine print** window, select **Accept and start Skype for Business**.
11. Confirm that **Abbi Skinner** is signed in.
12. In the **Find** box, enter **adam@adatumyyxxxxx.hostdomain.com**, and then confirm that **Adam Hobbs** resolves on the **MY CONTACTS** tab.
13. Right-click **Adam Hobbs**, and then select **Add to Favorites**.
14. On **LON-SFB**, open Internet Explorer.
15. In the address bar, enter **https://portal.office.com/adminportal/home**, and then press Enter.
16. Sign in as **Beth@adataumyyxxxxx.onmicrosoft.com** with the password you created in Module 1.

    >**Note:** If Stay signed in? page appears click **No**.

    > **Note:** Steps 17-21 should have been completed as part of the Module 04 Lab. After you confirm that Adam, Abbi, Allan, Cai, Ella, and Jon have been assigned Office 365 Enterprise E5 licenses, you can skip to step 22.

17. Click **Admin**, and then select **Users**. Select **Active Users**, and then select the check boxes for the following user accounts:

  - **Adam Hobbs**
  - **Abbi Skinner**
  - **Allan Yoo**
  - **Cai Chu**
  - **Ella Perry**
  - **Jon Friday**

18. Scroll back to the top of the page, confirm 6 users are selected, select the ellipse icon (**...**), and then select **Manage Product licenses**. 
19. Under **Under Manage product licenses**, in the right pane, select **Add to existing product license assignments**, and then select **Next**.
20. Under **location**, select **United States**, assign the **Office 365 Enterprise E5** licenses by changing the switch from **Off** to **On**, and then select **Add**.
21. Confirm that six licenses were assigned, and then select **Close**.
1. On **LON-SFB**, restore the Skype for Business Management Shell window.
1. Run the following commands to move users from Skype for Business to Teams. Replace **Adatamyyyyxxxx.hostdomain.com** with the domain you created or were provided. Type **Y** and press **Enter** after each cmdlet:

    ```
    Move-CsUser -Identity adam@Adatumyyyyxxxx.hostdomain.com -Target sipfed.online.lync.com -Credential $Creds
    ```

    ```
    Move-CsUser -Identity Allan@Adatumyyyyxxxx.hostdomain.com -Target sipfed.online.lync.com -Credential $Creds
    ```

    ```
    Move-CsUser -Identity Cai@Adatumyyyyxxxx.hostdomain.com -Target sipfed.online.lync.com -Credential $Creds
    ```

    ```
    Move-CsUser -Identity Ella@Adatumyyyyxxxx.hostdomain.com -Target sipfed.online.lync.com -Credential $Creds
    ```

    ```
    Move-CsUser -Identity Jon@Adatumyyyyxxxx.hostdomain.com -Target sipfed.online.lync.com -Credential $Creds
    ```

    > **Note:** While the move is successful, the Skype for Business Server 2019 Edge (**LON-EDGE**) does not have a public IP in this lab environment. This will prevent full hybrid communications for this lab.

    > **Note:** If the move failed with the error "**Cannot find user in Active Directory with the follwing SIP URI**", run **Start-ADSyncSyncCycle -PolicyType Initial** on **LON-DS1** and try again after sync completes. It can take 30 minutes or longer for an **On-premises (hybrid)** user, like Adam Hobbs, to appear in the **Microsoft Teams Admin Center** after assigning the Office 365 Enterprise E5 license. Until provisioning completes, this error will persist.




#### Task 2: Configure Microsoft Teams for your Office 365 tenant

1. If not currently signed in, sign in to **LON-SFB** as **Adatum\Administrator** with the password **Pa55w.rd**.
2. Restore or open the Internet Explorer window.
3. In the address bar, enter **https://admin.teams.microsoft.com/dashboard**, and then press **enter**.
4. If prompted, sign in as **Beth@Adatumyyxxxxx.onmicrosoft.com** with the password you created in Module 1.

    >**Note:**  If **Stay signed in?** page appears click **No**.

5. In the left navigation pane, expand **Org-wide settings**, and then select **Teams upgrade**.
6. Confirm your trial tenant status. It should say **Congratulation! Your organization is already in Teams**.

     > **Note:** If your production organization, at work, still has Skype for Business Online licenses you may see upgrade options. You can choose an upgrade option for your organization on the **Teams upgrade** page, under **Coexistence mode**, by selecting the drop-down arrow. A change at this level will impact all users in the organization by default.

7. In the left navigation pane, select **Users**, and then review the list of users that are already licensed for Teams.
8. Select the **Directory status** tab to sort the table by status, and note the user accounts that have the status of **Online**.
9. Under **Org-wide settings**, review the default settings for the **External access** and **Guest Access** tabs.
10. In the Guest access window confirm the **Allow guest access in Teams** slider is **On**. Verify that all associated settings are also set to **On**, and then click **Save**.

    >**Note:** It can take up to 24 hours for the change to take effect.

11. Keep the **Microsoft Teams admin center** window open, as you will use it later in this lab.


#### Task 3: Verify communications between users on Skype for Business Server and users on Skype for Business Online

1. On **LON-CL1**, when prompted to sign in, sign in as **Adam@Adatumyyxxxxx.hostdomain.com** with the password **Pa55w.rd**.
2. If the **Use this account everywhere on your device** window appears verify that **Allow my organization to manage my device** is selected and then click **Yes**. 
3. If the **You're all set** page appears click **Done**. 
4. Verify whether **Adam** is able to sign in automatically to Skype for Business  after his account was moved.

    >**Note:** Even though the account was moved to Skype for Business Online, the organization is already a Teams only organization. Therefore all users moved to Office 365 will require a Teams client in this tenant. 

5. On the **Your organization is now using Microsoft Teams!** window, select **Go to Teams**, verify that **Adam** is automatically signed in to the Teams web client. 
6. On **LON-CL2**, verify you are still signed in as **Abbi@Adatumyyxxxxx.hostdomain.com** with the password **Moc10984B**.
7. Verify that **Abbi** is also still signed in to Skype for Business.
8. In the **Favorites** section, double-click **Adam Hobbs**.
9. In the IM window for Adam Hobbs, enter **Hello Adam**, and then select **Send**. Note the error that is returned.
10. On **LON-CL1**, restore the Teams web client.
11. Select Chat in the left navigation, select the Contacts tab, in the **Favorites** section, select **Abbi Skinner**.
12. In the **Type a new message** box for **Abbi Skinner**, enter **Hello Abbi**, and then select **Send**. Note the error that is returned.

    > **Note:** The IM communications between Adam and Abbi are not expected to work.

    > The **LON-EDGE** server does not have a public IP on the external interface in this lab environment. While there is internet access, it is from the internal network and the Web Application Proxy. This only provides limited functionality.

13. Close the Teams web client window.


#### Task 4: Verify communications between users on Skype for Business and Teams

1. On **LON-CL2**, open Microsoft Edge.
2. In the address bar, enter **https://teams.microsoft.com**, and then press Enter.
3. Sign in as **Abbi@Adatumyyxxxxx.hostdomain.com** with the password **Moc10984B**. If prompted to stay signed in, select **Yes**. If prompted to save your password, select **No**.
4. Select **Use the web app instead**. Close the **Bring your team together** page.
5. In the left pane, select **Chat**.
6. On the top of the **Teams** window, to the left of the **Search** box, select the **New Chat** icon.
7. In the **Search** box, enter **Adam**, and then, from the search results, select **Adam Hobbs**.
8. On the **Conversation** tab, in the **Type a new message** box, enter **Hello Adam!** and press Enter.
9. On **LON-CL1**, Open Microsoft Edge.
11. In the address bar, enter **https://teams.microsoft.com/downloads**, and then press Enter.
12. Under the **Desktop** , select **Windows 64-bit**.
13. When prompted, select **Save As**, browse to **C:\Labfiles\Mod05**, and then select **Save**.
14. After the download completes, select **Run**, close Edge and wait for installation to complete.

    > **Note:** If the download times out, try to download it again. It might take a few attempts, but it should eventually download.

    > If a message displays that says This App can't be run on your PC, this can be addressed by either of the following two methods:

    >  1. Open Microsoft Edge in **InPrivate** mode, and then download and run the application.

    >  2. In Microsoft Edge, under **Settings\View Advanced Settings**, turn off **Help protect me from malicious sites and downloads with Windows Defender SmartScreen**.

15. If prompted, in the **Login to Microsoft Teams** window, confirm that Adam@Adatumyyxxxxx.hostdomain.com is the specified username. enter **Pa55w.rd** as the password, and then select **Sign in**. 
16. If an additional window appears close it.

    > **Note:** The Teams desktop app is not included with an Office Pro Plus installation. However, you can download it from [https://teams.microsoft.com/downloads](https://teams.microsoft.com/downloads) for Windows, Mac, iOS, and Android.

17. In the left pane, note that **Chat** has a red **1**. Select **Chat**.
18. Under **Recent**, select **Abbi Skinner**.
19. In the **Type a new message** box, enter **Hello Abbi!**
20. Select the **Sticker** icon, and then select the **SuccessKid** sticker. Enter a **Top caption** and **Bottom caption**, and then select **Done**.
21. Select **Send**.
22. On **LON-CL2**, verify that **Abbi** received the chat.

> **Result**: After completing this exercise, you will have successfully:

- Configured Skype for Business Server 2019.
- Configured Teams.
- Tested Skype for Business and Teams communications.
- Tested Teams only communications.



## Exercise 4: Enable Office 365 Phone System and Audio Conferencing (Optional Exercise)

#### Task 1: Configure Audio Conferencing

1. On **LON-SFB**, verify that the **Microsoft Teams admin center** window is still open. If not, in the address bar, enter **https://admin.teams.microsoft.com/dashboard**.
2. Sign in as **Beth@Adatumyyxxxxx.onmicrosoft.com**.
3. In the **Microsoft Teams admin center**, in the feature pane, expand **Meetings**, and then select **Conference bridges**.
4. In the results pane, review the Microsoft conference bridge phone numbers available for your tenant. Locate and select the phone number listed as the **+1 ### ### ####(default)** number.
5. In the left navigation pane, select **Voice** and then select **Phone Numbers**.
6. Select **Add**, on the Order name page type **Virginia Conference Bridge** for the order name and **Toll Number** for the friendly description. 
7. Under the Location and quantity section, select Country/Region: **United States**, and then select **Dedicated conference bridge (Toll)** for the number type.
8. Click **Add a Location**, in Order name type **Virginia **, in the Country or region select **United States**, for the **Address** enter **12012 Sunset Hills Road, Reston, VA 20190** 

    >**Note:** The address should resolve automatically. If the address you type in doesn't resolve in the Master Street Address Guid (MSAG) then you will need to correct the address to match a suggested address. Only validated civic addresses can be used for a voice location.


9. Verify that **I acknowledge and agree that I have read this information and understand how emergency calling works in Microsoft Teams. Please provide this information to users with phone numbers in your organization** is selected and click **Save**.
10. In the location box type **Reston** and select **Virginia** from the list, in the Area code select **571**.
11. In the Quantity box type **1** and then click **Next**.

12. On the Get numbers page document the number displayed under **Reserved numbers**: ___________________
13. Click **Place order**.
14. On the Confirmation page click **Finish**.
15. In the **Microsoft Teams admin center**, expand **Meetings**, and then select **Conference bridges**.
16. In the **Conference bridges** window, select **Add** and then select **Toll number**.
17.  In the Add phone number dialog box select the Toll number that you documented and then click **Apply**.

    >**Note:** You may need to refresh the Internet Explorer browser window to see the new service number.

18. Locate and select the new number on the Conference bridges page. 
20. Select **Set as Default** and then click **Edit**.
21. In the properties pane for the number, review the default language and alternate language options available for the conference bridge number. Change the second alternate language from **none** to **French (Canada)**, and then select **Apply**.
22. In the left navigation pane, select **Meeting settings**, and then review the available settings for **Participants**, **Email invitation**, and **Network**.
23. Scroll down to **Select a port range for each type of real-time media traffic**, and then note the port range that is displayed.
24. Close Internet Explorer.

#### Task 2: Prepare for the next module

- When you are finished with the lab, keep all virtual machines running. The next lab/modules require the virtual machines in their current state.

> **Result**: After completing this exercise, you will have successfully added a new service number for audio conferencing.


©2019 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode "Creative Commons Attribution 3.0 License"), additional terms may apply. All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant. This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided "as-is." Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.



