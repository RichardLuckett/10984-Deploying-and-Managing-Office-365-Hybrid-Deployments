# Lab Answer Key:  Module 5: Skype for Business hybrid deployment
# Lab: Implement the Skype for Business hybrid configuration
  
## Exercise 1: Deploy Skype for Business with Enterprise Voice (pre-lab)
  
#### Task 1: Prepare the environment \(these steps have already been done for you\)

> **Note:** To save time, the steps in Task 1 and Task 2 have been completed for you. They are provided here for your information and future reference. You can proceed directly to **Task 3: Update Topology** to start this lab.

1. Sign in to **LON-SFB** as **Administrator\@adatum.com** with the password **Pa55w.rd**.
2. On the taskbar, select **Skype for Business Server Management Shell**.
3. Create a share for **LON-SFB** by running the following two commands:

  ```
  New-Item C:\SkypeShare -Type Directory
  ```

  ```
  New-SmbShare -Name SkypeShare -Path C:\SkypeShare -FullAccess "Domain Admins","Administrators"
  ```

4. Open File Explorer.
5. Browse to **D:\\Setup\\Amd64**, and then double-click **Setup.exe**.
6. If prompted, select **OK** to install Microsoft Visual C++ 2013 Redistributable \(x64 runtime\).
7. Confirm that the install location is **C:\\Program Files\\Skype for Business Server 2015**, and then select **OK** to continue and install the core components.
8. In the **Deployment Wizard** window, select **Install Administrative Tools**.
9. On the **Install Administrative Tools** page, select **Next**.
10. On the **Executing Commands** page, wait for the **Completed** status, and then select **Finish**.
11. In the **Deployment Wizard** window, select **Prepare Active Directory**, and then select **Run on Prepare Schema**.
12. Select **Prepare Current Forest**.
13. On the **Universal Group Location** page, select **Local domain**, and then select **Next**.
14. On the **Executing Commands** page, wait for the **Completed** status to appear, and then select **Finish**.
15. On the **Active Directory preparation** page, in the **Prepare Current Domain** step, select **Run**.
16. On the **Prepare Domain** page, select **Next**.
17. On the **Executing Commands** page, wait for the **Completed** status to appear, and then select **Finish**.
18. In the **Deployment Wizard** window, select **Back**.
19. On the main **Deploy** page, select **Prepare first Standard Edition server**.
20. On the **Prepare single Standard Edition Server** page, select **Next**.
21. On the **Executing Commands** page, wait for the **Completed** status to display, and then select **Finish**.
22. Right-click **Start**, and then select **Run**.
23. In the **Open** box, enter **dsa.msc**, and then select **OK**.
24. In the **Active Directory Users and computers** window, expand **Adatum.com**, select **Users**, and then double-click **CSAdministrator**.
25. In the **CSAdministrator Properties** window, select **Members**, and then select **Add**.
26. In the **Select users, Contacts, Computes, Service Accounts or Groups** dialog box, in the **Enter the object names to select files** box, enter **Administrator**, and then select **OK** twice.
27. Repeat Steps 23-26 for the **RTCUniversalServerAdmins security** group.
28. Close the **ADUC** window.
29. To apply the new permission, select **Start**, **Shutdown or sign out**, and then select **Sign out**.
30. Sign back in as **Adatum\\Administrator** with the password **Pa55w.rd**.
31. Right-click **Start**, and then select **Run**.
32. In the **Open** box, enter **cmd.exe**, and then select **OK**.
33. Run the following commands to confirm that correct permissions have been applied:

  ```
  whoami /groups /fo list | findstr /i CsAdmin 
  ```

  ```
  whoami /groups /fo list | findstr /i RTC
  ```


#### Task 2: Define topology \(these steps have already been done for you\)

> **Note:** To save time, the steps in Task 1 and Task 2 have been completed for you. They are provided here for your information and future reference. You can proceed directly to**Task 3: Update Topology** to start this lab.

1. Sign in to **LON-SFB** as **Administrator\@adatum.com** with the password **Pa55w.rd**.
2. On the taskbar, select **Skype for Business Server Topology Builder**.
3. In the **Topology Builder** window, select **New Topology**, and then select **OK**.
4. Browse to **C:\\Labfiles\\Mod05**, enter **Lab5.tbxml**, and then select **Save**.
5. In the **Create New Topology Wizard**, on the **Define the primary domain** page, enter **adatumyyxxxxx.hostdomain.com**, and then select **Next**.
6. On the **Specify additional supported domains** page, select **Next**.
7. On the **Define the first site** page, in the **Name** box, enter **Adatum**, and then select **Next**.
8. On the **Specify site details** page, in the **City** box, enter **London**, in the **State/Province** box, enter **England**, in the **Country/Region Code** box, enter **UK**, and then select **Next**.
9. On the **New topology was successfully defined** page, ensure that **Open the New Front End Wizard when this wizard closes** is selected, and then select **Finish**.
10. In the **Define New Front End Pool Wizard**, on the **Define the New Front End pool** page, select **Next**.
11. On the **Define the Front End pool FQDN** page, in the **FQDN** box, enter **lon-sfb.adatum.com**, select **Standard Edition Server**, and then select **Next**.
12. On the **Select Features** page, select the **Conferencing** check box, select the **Enterprise Voice** check box, and then select **Next**.
13. On the **Select collocated server roles** page, verify that **Collocate Mediation Server** is selected, and then select **Next**.
14. On the **Associate server roles with this Front End Pool** page, select the **Enable an Edge pool to be used by the media component of this Front End pool** check box, and then select **Next**.
15. On the **Select an Edge Server** page, select **New**.
16. In the **Define New Edge Pool Wizard**, on the **Define the New Edge Pool** page, select **Next**.
17. On the **Define the Edge pool FQDN** page, in the **Pool FQDN** box, enter **lon-edge.adatum.com**. Select **This pool has one server**, and then select **Next**.
18. On the **Enable Federation** page, select the **Enable federation \(Port 5061\)** check box, ensure all the other check boxes are cleared, and then select **Next**.
19. On the **Select Features** page, select the **Use a single FQDN and IP address** check box, and then select **Next**.
20. On the **Select IP options** page, ensure that both the **Enable IPv4 on internal interface** and the **Enable IPv4 on external interface** check boxes are selected and all other check boxes are cleared, and then select **Next**.
21. On the **External FQDNs** page, in the **Access Edge service** box, enter **access.adatumyyxxxxx.hostdomain.com**. Review the ports that are assigned to other services, and then select **Next**.
22. On the **Define the internal IP address** page, in the **Internal IPv4 address** box, enter **172.16.0.16**, and then select **Next**.
23. On the **Define the external IP address** page, in the **External IPv4 address** box, enter **10.0.0.16**, and then select **Next**.
24. On the **Define the next top server** page, verify that **lon-sfb.adatum.com Adatum** is selected, and then select **Finish**.
25. In the **Define New Front End Pool Wizard**, on the **Select and Edge Server** page, verify that **lon-edge.adatum.com Adatum** is selected, and then select **Next**.
26. On the **Define the SQL Server store** page, leave the default settings, and then select **Next**.
27. On the **Define the File Store** page, verify that **Define a new file store** is selected and**lon-sfb.adatum.com** is listed as the **File server FQDN**, change **File share** to**SkypeShare**, and then select **Next**.
28. On the **Specify the Web Services URL** page, change the **External Base URL** string to**web-ext.adatumyyxxxxx.hostdomain.com**, and then select **Next**.
29. On the **Select an Office Web Apps Server** page, clear the **Associate pool with an Office Web Apps Server** check box, and then select **Finish**.
30. In the **Skype for Business Server 2015 Topology Builder** window, expand the **Adatum** site, expand **Skype for Business Server 2015**, expand **Mediation pools**, right-click **lon-sfb.adatum.com**, and then select **Edit Properties**.
31. In the **Edit Properties** window, under **Mediation server PSTN gateway**, select the **Enable TCP port** check box, and then select **OK**.
32. In the **Skype for Business Server 2015 Topology Builder** window, expand **Shared Components**, right-click **PSTN gateways**, and then select **New IP/PSTN Gateway**.
33. In the **Define New IP/PSTN Gateway Wizard**, on the **Define the PSTN Gateway FQDN** page, in the **FQDN** box, enter **172.16.0.210**, and then select **Next**.
34. On the **Define the IP address** page, leave the default settings, and then select **Next**.
35. On the **Define the root trunk** page, enter the following settings, and then select Finish:

  - Trunk Name: **IP-PBX**
  - Listening port for the IP/PSTN gateway: **5060**
  - SIP Transport Protocol: **TCP**
  - Associated Mediation Server port: **5068**

  > **Note:** The Associated Mediation Server port will change automatically from 5067 to 5068 after you change the SIP Transport Protocol from TLS to TCP.
  > If you have not enabled TCP ports on the Mediation Server, you will not be able to configure an IP Gateway/Trunk to use the TCP port.

36. In the **Skype for Business Server 2015 Topology Builder** window, right-click the **Skype for Business Server** container, and then select **Edit Properties**.
37. In the **Edge Properties** window, in the left navigation pane, select **SIP domain**, and then verify that the sip domain matches your assigned public domain. For example: **adatumyyxxxxx.hostdomain.com**
38. Scroll down to the **Simple URLs** section. Review the **Phone access URLs** and**Meeting URLs**, and then in the **Administrative access URL** box, enter **https://admin.adatumyyxxxx.hostdomain.com**.
39. Scroll down to the **Central Management Server** section. Select the **Front End Server to install Central Management Server on** drop-down box, select **lon-sfb.adatum.com Adatum**, and then select **OK**.
40. Right-click **Adatum**, and then select **Edit Properties**.
41. In the left navigation pane, select **Federation route**. In the drop-down box, verify that **Enable SIP federation** and**lon-edge.adatum.com Adatum Edge** are selected, and then select **OK**.
42. Right-click **Adatum**, select **Topology**, and then select **Publish**.
43. On the **Publish the topology** page, select **Next**.
44. On the **Select Central Management Server** page, verify that **lon-sfb.adatum.com Adatum** is selected, and then select **Next**.

  > **Note:** The expected results are that all publishing steps have a **Success** status.

45. Close the **Skype for Business Server Topology Builder** window.


#### Task 3: Update the topology
  

1. Sign in to **LON-SFB** as **Administrator\@adatum.com** with the password **Pa55w.rd**.
2. Open File Explorer.
3. Browse to **C:\\Labfiles\\Mod05**.
4. Right-click **Lab5.txt**, select **Open with**, and then select **Notepad**.
5. In Notepad, select the **Edit** menu, and then select **Replace**.
6. In the **Replace** window, in the **Find what** box, enter **adatumyyxxxxx.hostdomain.com**. In the **Replace with** box, enter the public domain you were assigned \(for example, **adatumAB12345.hostdomain.com**\), and then select **Replace All**.
7. Close the **Replace** window.
8. In the **Lab5.txt - Notepad** window, select the **File** menu, and then select **Save As**.
9. Save the file name as **Lab5.tbxml**, change the **Save as type** to **All files \(\*.\*\)**, and then select **Save**.

  > **Note:** Be careful not to leave a .txt extension on the filename.

10. When the **Confirm Save As** dialog box appears, select **Yes**.
11. Close Notepad.
12. On the taskbar, select **Skype for Business Server Topology Builder**.
13. In the **Topology Builder** window, select **Open Topology from a local file**, and then select **OK**.
14. Browse to **C:\\Labfiles\\Mod05**, select **Lab5.tbxml**, and then select **Open**.
15. In the **Skype for Business Server 2015 Topology Builder** window, review the following settings and verify that the domain name provided to you has been accurately applied to the topology builder file:
 
  - **SIP Domain**
  - **Simple URLs**
  - **Skype for Business Server 2015** \> **Standard Edition** &gt; **Front End Servers** &gt; **lon-sfb.adatum.com** &gt; **External web services**
  - **Edge pools** \> **lon-edge.adatum.com** &gt;**External settings**

  > **Note:** The expected result is that your assigned adatumyyxxxxx.hostdomain.com has replaced the placeholder values.
  > Be aware that a Skype for Business Server 2015 Standard Edition server's internal Fully Qualified Domain Names \(FQDNs\) must match its Active Directory Domain \(AD DS\) FQDN. This is different from the Enterprise Edition pool FQDN. In this lab, that means that the pool FQDN must be **lon-sfb.adatum.com**. The internal FQDN of **LON-EDGE** is also **lon-edge.adatum.com**.
  > If you see any discrepancies or have any concerns about the settings, please let your instructor know before continuing.
  > If everything looks okay, you are ready to continue to the next step and publish the topology.

16. Right-click **Adatum**, select **Topology**, and then select **Publish**.
17. On the **Publish the topology** page, select **Next**.
18. On the **Select Central Management Server** page, verify that **lon-sfb.adatum.com Adatum** is selected, and then select **Next**.

  > **Note:** The expected results are that all publishing steps have a **Success** status.

19. On the **Publishing wizard complete** page, select **Finish**.
20. Close the **Skype for Business Server 2015, Topology Builder** window.


#### Task 4: Run deployment scripts
  

1. Sign in to **LON-SFB** as**Administrator\@adatum.com** with the password **Pa55w.rd**.
2. On the taskbar, select **File Explorer**.
3. In File Explorer, browse to **C:\\Labfiles\\Mod05**. 
4. Right-click **SfBSetup.txt**, and then select **Rename**. Change .**txt** to **.ps1**, and then press **Y** to accept the change.
5. Right-click **SfBSetup.ps1**, and then select **Edit**.
6. In the **Windows PowerShell ISE** window, verify that the **SfBSetup.ps1** file is open.
7. At the **Windows PowerShell** command prompt, enter the following cmdlet, and then press Enter:

  ```
  Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force
  ```

8. In the **Windows PowerShell ISE** window, on the toolbar, select **Run Script**.
9. When prompted, enter **adatumyyxxxxx.hostdomain.com**, substituting your assigned domain name, and then press Enter.
10. At the **Windows PowerShell** prompt, verify the name you entered, and then press**Y** or select **Yes**.
11. Open File Explorer, browse to drive **D**, and then confirm that the Skype for Business Server 2015 **Setup**, **Support** and **autorun.inf** objects are visible.
12. Close File Explorer.
13. To allow the script to continue, in the **Windows PowerShell ISE** window, press Enter.

  > **Note:** Do not stop or pause the script. The script will continue to run.
  > It will take approximately 25 minutes for the script to complete. Continue with Exercise 2, and return to the **Windows PowerShell ISE** window after completing Exercise 2, Task 1 and Task 2.

14. After the script completes, press Enter to restart **LON-SFB**.
15. Sign in to **LON-SFB** as**Adatum\\Administrator** with the password **Pa55w.rd**.
16. Sign in to **LON-DC1** as**Adatum\\Administrator** with the password **Pa55w.rd**.
17. Open Windows PowerShell, enter the following command, and then press Enter:

  ```
  Restart-Service CertSvc
  ```

18. Close Windows PowerShell.
19. Sign in to **LON-EDGE** as **LON-EDGE\Administrator** with the password **Pa55w.rd**.
20. Open File Explorer.
21. Browse to **C:\\Labfiles\\Mod05**.
22. Right-click **EDGESetup.txt**, select **Rename**, change **.txt** to **.ps1**, and then press **Y** to accept the change.
23. Right-click **EDGESetup.ps1**, and then select **Edit**.
24. In the **Windows PowerShell ISE** window, verify that the **EDGESetup.ps1** file is open.
25. At the **Windows PowerShell** command prompt, enter the following cmdlet, and then press Enter:

  ```
  Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force
  ```

26. In the **Windows PowerShell ISE** window, on the toolbar, select **Run Script**.
27. Open File Explorer, browse to drive **D**, and then confirm that the Skype for Business Server 2015 **Setup**, **Support** and **autorun.inf** objects are visible.
28. Close File Explorer.
29. To allow the script to continue, in the **Windows PowerShell ISE** window, press Enter.

  > **Note:** Do not stop or pause the script. The script will continue to run, and will take approximately 10 minutes to complete.

30. After the script completes, press Enter to restart **LON-EDGE**.
31. Sign in to **LON-EDGE** as **LON-EDGE\Administrator** with the password **Pa55w.rd**.

> **Result:** After completing this exercise, you will have prepared the lab environment for the remainder of Lab 5.



## Exercise 2: Design and implement a Skype for Business hybrid configuration
  
#### Task 1: Read and analyze the scenario requirements
  
1. Read the exercise scenario and analyze the requirements from an integration perspective.
2. Identify the configurations that are necessary to satisfy the requirements.
3. Sign in to **LON-CL1** as **Adatum\\Beth** with the password **Pa55w.rd**.
4. Open File Explorer, browse to **C:\\Labfiles\\Mod05**, and then open **10984\_Lab5\_Design.pptx**.
5. Use the PowerPoint slides to help you document your design.


#### Task 2: Design and discuss a solution with the class
Use the questions below to help refine your solution.

- **Question 1**: What components do you need to install and configure to satisfy the requirements? 

  **Answer**: You need the following configurations:

  - You must use password synchronization as your password-management solution because it requires the least amount of administrative effort.
  - You must deploy an edge server and configure federation and shared namespace.
  - You must deploy an HTTP proxy.

- **Question 2**: What are the licensing requirements for Skype for Business Online? 

  **Answer**: You will need either the E5 or E3 license with the add-on for Office 365 Phone System.

- **Question 3**: When moving users to Skype for Business Online, what precautions should Adatum take based on their existing environment? 

  **Answer**: They should not move the Research department as XMPP is not supported in Skype for Business Online. They should enable users for Enterprise Voice before moving them to Skype for Business Online.

- **Question 4**: Which hybrid voice solution will work best for Adatum? 

  **Answer**: They should use Phone System with on-premises PSTN calling by using an existing Skype for Business environment.

- **Question 5**: What would be different if Adatum were running only Lync Server 2010 and not Skype for Business Server 2015 on-premises? 

  **Answer**: You would need to deploy a Skype for Business edge server to support the hybrid voice requirements with an existing Lync Server 2010 environment.

Present your proposed solution to the class. Discuss alternative solutions with the students.



#### Task 3: Configure Enterprise Voice
  
1. Sign in to **LON-SFB** as **Adatum\\Administrator** with the password **Pa55w.rd**.
2. Open Skype for Business Server Control Panel and sign in as **Adatum\\Administrator** with the password **Pa55w.rd**.
3. In the left navigation pane, select **Voice Routing**, and then select the **DIAL PLAN** tab.
4. Select **New**, and then select **User dial plan**.

  > **Note:** While a site-level dial plan might be preferable for an Enterprise Voice deployment, user-level dial plans are preferable in a hybrid configuration.

5. In the **Name** box, enter **London**.
6. In the **Simple name** box, enter **London**.
7. In the **Description** box, enter **London Dial Plan**.
8. In the **Dial-in conferencing region** box, enter **UK**.
9. In the **Associated Normalization Rules** section, select **Keep All**, and then select **Remove**.
10. Under **Associated Normalization Rules**, select **New**.
11. On the **New Normalization Rule** page, in the **Name** box, enter **London PBX Extensions \[5 digits\]**.
12. In the **Description** box, enter **5 digit PBX extensions to E.164**.
13. In the **Starting Digits** box, enter **950**.
14. In the **Length** drop-down list, select **Exactly**.
15. In the **Length** box, enter or select **5**.
16. In the **Digits to remove** box, enter or select **0**.
17. In the **Digits to add** box, enter **+4420790**.
18. In the **Dialed number to test** box, enter **95011**, and then select **Go**.
19. Verify that **+442079095011** displays next to **Normalized number**.
20. Select **OK** to close the **New Normalization Rule** page.
21. Under **Associated Normalization Rules**, select **New**.
22. On the **New Normalization Rule** page, in the **Name** box, enter **London SfB Extensions \[5 digits\]**.
23. In the **Description** box, enter **5 digit SfB extensions to E.164**.
24. In the **Starting Digits** box, enter **123**.
25. In the **Length** drop-down list, select **Exactly**.
26. In the **Length** box, enter or select **5**.
27. In the **Digits to remove** box, enter or select **0**.
28. In the **Digits to add** box, enter **+4420793**.
29. In the **Dialed number to test** box, enter **12301**, and then select **Go**.
30. Verify that **+442079312301** displays next to **Normalized number**.
31. Select **OK** to close the **New Normalization Rule** page.
32. Under **Associated Normalization Rules**, select **New**.
33. On the **New Normalization Rule** page, in the **Name** box, enter **UK National Numbers**.
34. In the **Description** box, enter **UK National numbers to E.164**.
35. In the **Build a Normalization Rule** box, select **Edit**.
36. In the **Match this pattern** box, replace the existing value with:

  ```
  ^0((1224|1268|28|121|1254|1253|1204|1202|1274|1273|20)(\d+))
  ```

37. In the **Translation Rule** box, replace the existing value with **+44$1**, and then select **OK**.
38. In the **Dialed number to test** box, enter **01224123456**, and then select **Go**.
39. Verify that **+441224123456** displays next to **Normalized number**.
40. Select **OK** to close the **New Normalization Rule** page.
41. Under **Associated Normalization Rules**, select **New**.
42. On the **New Normalization Rule** page, in the **Name** box, enter **UK International Numbers**.
43. In the **Description** box, enter **UK International numbers to E.164**.
44. In the **Starting Digits** box, type **00**.
45. In the **Length** drop-down list, select **At Least**.
46. In the **Length** box, enter or select **5**.
47. In the **Digits to remove** box, enter or select **2**.
48. In the **Digits to add** box, enter **+**.
49. In the **Dialed number to test** box, enter **0031205002500**, and then select **Go**.
50. Verify that **+31205002500** displays next to **Normalized number**.
51. Select **OK** to close the **New Normalization Rule** page.
52. Under **Associated Normalization Rules**, select **New**.
53. On the **New Normalization Rule** page, in the **Name** box, enter **London Service Numbers**.
54. In the **Description** box, enter **London Service numbers to E.164**.
55. In the **Build a Normalization Rule** box, select **Edit**.
56. In the **Match this pattern** box, replace the existing value with:

  ```
  ^((118)(\d{3}))$
  ```

57. In the **Translation Rule** box, replace the existing value with **+$1**, and then select **OK**.
58. In the **Dialed number to test** box, enter **118212**, and then select **Go**.
59. Verify that **+118212** displays next to**Normalized number**.
60. Select **OK** to close the **New Normalization Rule** page.
61. Select **OK** to close the **New Dial Plan** page.
62. On the **Dial Plan** page, select **Commit**, select **Commit all**.
63. In the **Uncommitted Voice Configuration Settings**, review the changes, and then select **OK**.
64. Verify the dial plans were successfully published, and then select **Close**.
65. In the **Skype for Business Server 2015 Control Panel**, on the **DIAL PLAN** tab, double-click **Global**.
66. In the **Associated Normalization Rules** window, select **Keep All**, and then select **Remove**.
67. Under **Associated Normalization Rules**, select **New**.
68. On the **New Normalization Rule** page, in the **Name** box, enter **All digit Inbound to E.164**.
69. In the **Description** box, enter **Catch All to E.164**.
70. In the **Starting Digits** box, don't enter anything.
71. In the **Length** drop-down list, select **Any**.
72. In the **Digits to remove** box, enter or select **0**.
73. In the **Digits to add** box, enter **+**, and then select **OK**.
74. Select **OK** to close the **Edit Dial Plan - Global** page.
75. Select **Commit**, select **Commit All**, and then select **OK**.
76. Close the **Skype for Business Server 2015 Control Panel** dialog box.
77. In the **Skype for Business Server 2015 Control Panel**, select **Voice Routing**, select **ROUTE**, and then select **New**.
78. On the **New Voice Route** page, use the following information to configure the route.

  - Name: **London PBX**
  - Description: **Route to London PBX**

79. In the **Starting digits for numbers that you want to allow** box, enter **+4420790**, and then select **Add**.
80. Verify that the **Match this Pattern** box displays **^\\+4420790**.
81. Verify that **Suppress caller ID** is not selected.
82. Next to the **Associated Trunks** list field, select **Add**.
83. In the **Select Trunk** window, select **PstnGateway:172.16.0.210 Adatum**, and then select **OK**.
84. In the **Associated PSTN Usages** window, select **select**.
85. In the **Select PSTN Usage Record** window, select **Local**, and then select **OK**.
86. Under **Translated Number to test**, enter **+442079095011**, and then select **Go**.
87. Verify that the test result shows **Matches the regular expression that you built**, and then select **OK**.
88. On the **Route** page, select **Commit**, select **Commit all**, and then select **OK**.
89. In the **Uncommitted Voice Configuration Settings**, review the changes, and then select **OK**.
90. Verify that the routes were successfully published, and then select **Close**.
91. In the **Skype for Business Server 2015 Control Panel**, select **Voice Routing**, and then select **VOICE POLICY**.
92. On the **Voice Policy** tab, select **New**, and then select **User Policy**.
93. In the **Name** box, enter **London Voice Policy**.
94. In the **Description** box, enter **London User Voice Policy**.
95. Under **Calling Features**, leave all the default calling features:

  | **Feature** | **Option** |
  |-------------|------------|
  | Enable Call Forwarding | Selected |
  | Enable Team Call | Selected |
  | Enable Delegation | Selected |
  | Enable PSTN Reroute | Selected |
  | Enable Call Transfer | Selected |
  | Enable Bandwidth Policy Override | Cleared |
  | Enable Call Park | Cleared |
  | Enable Malicious call tracing | Cleared |
  | Enable Simultaneous ringing of phones | Selected |

96. Under **Associated PSTN Usages**, select **New**.
97. On the **New PSTN Usage Record** page, enter **London PBX Extensions**.
98. Under **Associated Routes**, select **select**, select **London PBX**, and then select **OK**.
99. Select **OK** to close the **New PSTN Usage Record** window.
100. Scroll down and verify that **Call forwarding and simultaneous ringing PSTN Usages** is set to**Route using the call PSTN usages**.
101. Under **Translated number to test**, enter **+442079095011**, and then select **Go**.
102. Verify that the **Match this PSTN usage record** box displays**London PBX Extensions** and the **Match this route pattern** box displays**London PBX**, and then select **OK**.
103. On the **Voice Policy** page, select **Commit**, select **Commit all**.
104. In the **Uncommitted Voice Configuration Settings**, review the changes, and then select **OK**.
105. Verify that the voice policies were successfully published, and then select **Close**.
106. In Skype for Business Server 2015 Control Panel, select **Voice Routing**, and then select **TRUNK CONFIGURATION**.
107. Select **New**, and then select **Pool Trunk**.
108. In the **Select a Service** window, select **PstnGateway:172.16.0.210 - Adatum**, and then select **OK**.
109. In the **New Trunk Configuration - PstnGateway:172.16.0.210** window, under **Description**, enter **London PBX Trunk configuration**.
110. Verify that **Maximum Early Dialogs Supported** is set to **20**.
111. Change **Encryption support level** to **Optional**.
112. Verify that **Refer Support** is set to **Enable Sending Refer to the Gateway**.
113. Verify that **Enable media bypass** is not selected.
114. Verify that **Centralized media processing** is selected.
115. Verify that **Enable RTP Latching** is not selected.
116. Verify that **Enable forward call history** is not selected.
117. Verify that **Enable forward P-asserted Identity data** is not selected.
118. Verify that **Enable outbound routing failover timer** is selected.
119. In the **Associated translation rules, Called Number translation rules** window, select **New**.
120. In the **New Trunk Configuration - New Called Number Translation Rule** window, in the **Name** box, enter **London - e.164 to 5 digit internal extension**.
121. Under **Description**, enter **Translate the e.164 number to a 5 digit internal extension for London**.
122. In the **Build a Translation Rule** window, in the **Starting digits** box, enter **+442079**.
123. In the **Length** box, enter or select **Exactly** and**13**.
124. In the **Digits to Remove** box, enter or select **8**.
125. Verify that the **Digits to Add** box is empty, and then select **OK**.
126. In the **New Trunk Configuration - PstnGateway172.16.0.210** window, under **Phone Number to Test**, enter **+442079095011**, select **Called Number**, and then select **Go**.
127. Verify that the **Translation rule** box displays **95011**, the **Rule to Match** box displays **London - e.164 to 5 digit internal extension**, and then select **OK**.
128. On the **Trunk Configuration** page, select **Commit**, select **Commit all**.
129. In the **Uncommitted Voice Configuration Settings**, review the changes, and then select **OK**.
130. Verify that the routes were successfully published, and then select **Close**.
131. In the left navigation pane, select **Users**.
132. On the **USER SEARCH** page, select **Enable users**, and under **New Skype for Business Server User**, select **Add**.
133. In the **Search** box, enter **Holly**, and then select **Find**.
134. Select **Holly Spencer**, and then select **OK**.
135. In the **Assign users to a pool** drop-down box, select **lon-sfb.adatum.com**.
136. Under **Generate user's SIP URI**, select **Use the user principal name (UPN)**.
137. In the **Telephony** drop-down box, select **Enterprise Voice**.
138. In the **Line URI** box, enter **tel:+442079312380**.
139. In the **Dial plan policy** drop-down box, select **London**.
140. In the **Voice policy** drop-down box, select **London Voice Policy**.
141. On the **USER SEARCH** page, select **Enable**.
142. Repeat steps 132 -141 to enable the following users for Skype for Business with Enterprise Voice by using the Line URI provided for each user.

  |  **User** | **Line URI** |
  |-----------|--------------|
  | Adam Hobbs | tel:+442079312341 |
  | Beth Burke | tel:+442079312335 |
  | Abbi Skinner | tel:+442079312310 |
  | Allan Yoo | tel:+442079312320 |
  | Cai Chu | tel:+442079312383 |
  | Ella Perry | tel:+442079312372 |
  | Jon Friday | tel:+442079312308 |

143. In the left navigation pane, select **Federation and External Access**, and then select the **EXTERNAL ACCESS POLICY** tab.
144. On the **EXTERNAL ACCESS POLICY** tab, review the settings for the **Global** policy. Note that there no external access options enabled.
145. Select the **ACCESS EDGE CONFIGURATION** tab and review the settings for the **Global** policy. Note that no external access options are enabled.
146. Select **SIP FEDERATED DOMAINS**, and then verify that there are no **Allowed or Blocked** domains configured.
147. Sign in to **LON-DS1** as **Adatum\\Administrator** with the password **Pa55w.rd**.
148. Open Windows PowerShell.
149. In the **Windows PowerShell** window, enter the following cmdlet, and then press Enter:

  ```
  Start-ADSyncSyncCycle -PolicyType Initial
  ```


#### Task 4: Deploy a Skype for Business hybrid configuration
  
1. On **LON-SFB**, open File Explorer, browse to **C:\\LabFiles\\Mod05**, and then double-click **msoidcli_64bit.msi**.
2. Install the Microsoft Online Services Sign-in Assistant by using the default settings, and then select **Finish**.
3. On the taskbar, select **Skype for Business Server Management Shell**.
4. At the **Skype for Business Server Management Shell** command prompt, enter the following command, and then press Enter:

  ```
  Install-Module MSOnline
  ```

5. In the **NuGet provider is required to continue** box, enter **Y**, and then press Enter.
6. In the **Untrusted Repository** box, enter **Y**, and then press Enter.
7. At the **Skype for Business Server Management Shell** command prompt, enter the following command, and then press Enter:

  ```
  Set-CSAccessEdgeConfiguration -AllowOutsideUsers 1 -AllowFederatedUsers 1 -EnablePartnerDiscovery 1 -UseDnsSrvRouting -AllowAnonymousUsers 1
  ```

8. Enter the following command, and then press Enter:

  ```
  Set-CsExternalAccessPolicy -EnableFederationAccess 1 -EnablePublicCloudAccess 1 -EnableOutsideAccess 1
  ```

9. Enter the following command, and then press Enter:

  ```
  Get-CsHostingProvider | Remove-CsHostingProvider
  ```

  > **Note:** This will remove any existing hosting provider to create a clean environment for the lab.

10. Enter the following command, and then press Enter:

  ```
  New-CSHostingProvider -Identity SkypeforBusinessOnline -ProxyFqdn sipfed.online.lync.com -Enabled $true -EnabledSharedAddressSpace $true -HostsOCSUsers $true -VerificationLevel UseSourceVerification -IsLocal $false -AutodiscoverUrl https://webdir.online.lync.com/Autodiscover/AutodiscoverService.svc/root
  ```

11. Enter the following command, and then press Enter:

  ```
  $creds=Get-Credential
  ```

12. When prompted, enter your Office 365 lab tenant administrator account username and password. For example, Beth\@adatumyyxxxxx.onmicrosoft.com.
13. Enter the following command, and then press Enter:

  ```
  Import-Module SkypeOnlineConnector
  ```

  > **Note:** You can safely ignore the warnings about WSMan NetworkDelayms.

14. Enter the following command, and then press Enter:

  ```
  $CSSession = New-CsOnlineSession -Credential $creds
  ```

15. Enter the following command, and then press Enter:

  ```
  Import-PSSession $CSSession -AllowClobber
  ```

16. Enter the following command, and then press Enter:

  ```
  Set-CsTenantFederationConfiguration -SharedSipAddressSpace $True
  ```

17. Close the **Skype for Business Server Management Shell** command prompt.

  > **Note:** You should have now configured the environment in preparation for moving on-premises Skype for Business users to Skype for Business Online.

18. Open the **Skype for Business Server 2015 Control Panel**.
19. In the left navigation pane, select **Home**.
20. Under **Connection to Skype for Business Online**, select **Sign in to Office 365**.
21. Sign in to **Office 365** by using the Office 365 tenant administrator's credentials. For example, Beth\@adatumyyxxxxx.onmicrosoft.com. Use the password you created in Lab 1.
22. After the message **you have successfully signed in to Office 365** appears, select **Close**.
23. Under **Connection to Skype for Business Online**, select **Set up hybrid with Skype for Business Online**.

  > **Note:** We are running the **Set up hybrid with Skype for Business Online Wizard** to confirm that all the PowerShell cmdlets worked correctly.

24. On the **Set up Hybrid with Skype for Business Online** page, select **Next**.
25. If any red **X**s appear, then something expected is missing in the hybrid configuration.
26. Select **Next** to allow the wizard to configure the missing setting (or settings).
27. Confirm that green check marks appear next to all four hybrid configuration settings and select **Close**.

> **Note:** Leave the Skype for Business Server 2015 Control Panel open. You will need it in the next exercise.


> **Result**: After completing this exercise, you will have successfully:
>  - Read and analyzed the scenario requirements.
>  - Designed a solution.


## Exercise 3: Move users to Skype for Business Online
  
#### Task 1: Move users to Skype for Business Online
  
1. Sign in to **LON-CL1** as **Adatum\\Adam** with the password **Pa55w.rd**.
2.  select **Start**, enter **Skype**, and then select **Skype for Business 2016**.
3. In the **First things first** window, select **Ask me later**, and then select **Accept**.
4. Close the **Welcome** page.
5. If the Microsoft Office Activation Wizard window appears, Click **Close**.
6. Confirm that **Adam Hobbs** is signed in.
7. In the **Find** box, enter **abbi\@adatumyyxxxxx.hostdomain.com**, and then confirm that **Abbi Skinner** resolves on the **MY CONTACTS** tab.
8. Right-click **Abbi Skinner**, and then select **Add to Favorites**.
9. Sign in to **LON-CL2** as **Adatum\\Abbi** with the password **Moc10984A**.
10.  select **Start**, enter **Skype**, and then select **Skype for Business 2016**.
11. In the **First things first** window, select **Ask me later**, and then select **Accept**.
12. Close the **Welcome** page.
13. If the Microsoft Office Activation Wizard window appears, Click **Close**.
14. Confirm that **Abbi Skinner** is signed in.
15. In the **Find** box, enter **adam\@adatumyyxxxxx.hostdomain.com**, and then confirm that **Adam Hobbs** resolves on the **MY CONTACTS** tab.
16. Right-click **Adam Hobbs**, and then select **Add to Favorites**.
17. On **LON-SFB**, open Internet Explorer.
18. In the address bar, enter **https://portal.office.com/adminportal/home**, and then press Enter.
19. Sign in as **Beth\@adataumyyxxxxx.onmicrosoft.com** with the password you created in Module 1.

  > **Note:** Steps 20-24 should have been completed as part of the Module 04 Lab. After you confirm that Adam, Abbi, Allan, Cai, Ella, and Jon have been assigned Office 365 Enterprise E5 licenses, you can skip to step 25.

20. Click **Admin**, and then select **Users**. Select **Active Users**, and then select the check boxes for the following user accounts:

  - **Adam Hobbs**
  - **Abbi Skinner**
  - **Allan Yoo**
  - **Cai Chu**
  - **Ella Perry**
  - **Jon Friday**

21. Under **Bulk actions**, in the right pane, select **Edit product licenses**.
22. Under **Assign products**, select **Add to existing product license assignments**, and then select **Next**.
23. Under **location**, select **United States**, assign the **Office 365 Enterprise E5** licenses by changing the switch from **Off** to **On**, and then select **Add**.
24. Confirm that six licenses were assigned, and then select **Close**.
25. Restore the **Skype for Business Server 2015 Control Panel** window.
26. In the left navigation pane, select **Home**. Under **Connection to Skype for Business Online**, verify that you are still signed in to Office 365 with tenant credentials.
27. In the **Skype for Business Control Panel** window, in the left navigation pane, select **Users**. On the **USER SEARCH** tab, select **Find**.
28. Verify that a list of all Skype for Business-enabled users displays.
29. Select **Adam Hobbs**, select **Action**, and then select **Move selected users to Skype for Business Online**.
30. In the **Move users to Skype for Business Online** Wizard, select **Next**.
31. If your credentials have expired, you will get a message that says **You're not signed into Office 365**. If this occurs, select **Sign in to Office 365**, and then sign in with your Microsoft Office 365 tenant credentials. For example, Beth\@adatumyyxxxxx.onmicrosoft.com.
32. Use the password you created in Lab 1.
33. After you sign in, select **OK**, and then select **Close**.
34. In the **Move users to Skype for Business Online** Wizard, select **Next**.
35. When a message, "Do you want to move the selected users," appears, select **Next**.

  > **Note:** While the move is successful, the Skype for Business Server 2015 Edge \(**LON-EDGE1**\) does not have a public IP in this lab environment. This will prevent full hybrid communications for this lab.

36. Close the **Move users to Skype for Business Online** Wizard.


#### Task 2: Configure Microsoft Teams for your Office 365 tenant
  
1. Sign in to **LON-SFB** as **Adatum\\Administrator** with the password **Pa55w.rd**.
2. Open Internet Explorer.
3. In the address bar, enter **https://admin.teams.microsoft.com/dashboard**, and then press **enter**.
4. Sign in as **Beth\@Adatumyyxxxxx.onmicrosoft.com** with the password you created in Module 1.
5. In the left navigation pane, expand **Org-wide settings**, and then select **Teams upgrade**.
6. To see the upgrade options, on the **Teams upgrade** page, under **Coexistence mode**, select the drop-down arrow.
7. Select **Skype for Business Only**, and then select **Save**.

  > **Note:** A change at this level will impact all users in the organization by default.

8. In the left navigation pane, select **Users**, and then review the list of users that are already licensed for Teams.
9. Select the **Directory status** tab to sort the table by status, and note the user accounts that have the status of **Online (hybrid)**.

  > **Note:** Only Teams users that have the directory status of**Online (hybrid)** have full coexistence between their Skype for Business and Teams clients.

10. In the list of users, select **Adam Hobbs**.
11. On the **Adam Hobbs** page, in the **Teams upgrade** section, select **Edit**. (You might have to scroll down to see this section of the **Account** tab.)
12. In the Teams upgrade pane, in the **Coexistence mode** drop-down box, select **Islands**, and then select **Save**.
13. In the left navigation pane, select **Users**, and then, in the list of users, select **Abbi Skinner**.
14. On the **Abbi Skinner** page, in the **Teams upgrade** section, select **Edit**. (You might have to scroll down to see this section of the **Account** tab.)
15. In the Teams upgrade pane, in the **Coexistence mode** drop-down box, select **Islands**, and then select **Save**.
16. Under **Org-wide settings**, review the default settings for the **External access** and **Guest Access** tabs.
17. Keep the **Microsoft Teams &amp; Skype for Business Admin Center** window open, as you will use it later in this lab.


#### Task 3: Verify communications between users on Skype for Business Server and users on Skype for business Online
  
1. On **LON-CL1**, verify that you are still signed in as **Adam\@Adatumyyxxxxx.hostdomain.com**.
2. Verify whether **Adam** is able to sign in automatically to Skype for Business Online after his account was moved.
3. If not, sign in to Skype for Business as **Adam\@Adatumyyxxxxx.hostdomain.com** with the password **Pa55w.rd**.
4. On **LON-CL2**, verify you are still signed in as **Abbi\@Adatumyyxxxxx.hostdomain.com** with the password **Pa55w.rd**.
5. Verify that **Abbi** is also still signed in to Skype for Business.
6. In the **Favorites** section, double-click **Adam Hobbs**.
7. In the IM window for Adam Hobbs, enter **Hello Adam**, and then select **Send**. Note the error that is returned.
8. On **LON-CL1**, restore the Skype for Business client.
9. In the **Favorites** section, double-click **Abbi Skinner**.
10. In the **IM** window for**Abbi Skinner**, enter **Hello Abbi**, and then select **Send**. Note the error that is returned.

  > **Note:** The IM communications between Adam and Abbi are not expected to work.
  > The **LON-EDGE** server does not have a public IP on the external interface in this lab environment. While there is internet access, it is from the internal network and the Web Application Proxy. This only provides limited functionality.

11. Close the **IM** window.


#### Task 4: Verify communications between users on Skype for Business and Teams
  
1. On **LON-CL2**, open Microsoft Edge.
2. In the address bar, enter **https://teams.microsoft.com**, and then press Enter.
3. Sign in as **Abbi\@Adatumyyxxxxx.hostdomain.com** with the password **Moc10984A**. If prompted to stay signed in, select **Yes**. If prompted to save your password, select **No**.
4. Close the introduction pop-up window.
5. In the left pane, select **Chat**.
6. On the top of the **Teams** window, to the left of the **Search** box, select the **New Chat** icon.
7. In the **Search** box, enter **Adam**, and then, from the search results, select **Adam Hobbs**.
8. On the **Conversation** tab, in the **Type a new message** box, enter **Hello Adam!** and press Enter.
9. On **LON-CL1**, verify whether **Adam** received the chat message from **Abbi**.

  > **Note:** Adam should not receive the message in Skype for Business. Both Adam and Abbi are configured to use Islands coexistence. This option isolates the communications made between users so that they must use the same application to communicate with one another.

10. Open Microsoft Edge.
11. In the address bar, enter **https://teams.microsoft.com/downloads**, and then press Enter.
12. Under the **Desktop Apps in the Windows** tile, select **Download (64-bit)**.
13. When prompted, select **Save As**, browse to **C:\\Labfiles\Mod05**, and then select **Save**.
14. After the download completes, select **Run**.

  > **Note:** If the download times out, try to download it again. It might take a few attempts, but it should eventually download.
  > If a message displays that says This App can't be run on your PC, this can be addressed by either of the following two methods:
  >  1. Open Microsoft Edge in **InPrivate** mode, and then download and run the application.
  >  2. In Microsoft Edge, under **Settings\View Advanced Settings**, turn off **Help protect me from malicious sites and downloads with Windows Defender SmartScreen**.

15. In the **Login to Microsoft Teams** window, confirm that Adam\@Adatumyyxxxxx.hostdomain.com is the specified username. enter **Pa55w.rd** as the password, and then select **Sign in**. Note that at this point Adam is signed in to both Teams and Skype for Business desktop apps on **LON-CL1**.
16. If an additional window appears close it.

  > **Note:** The Teams desktop app is not included with an Office Pro Plus installation. However, you can download it from [https://teams.microsoft.com/downloads](https://teams.microsoft.com/downloads) for Windows, Mac, iOS, and Android.

17. In the left pane, note that **Chat** has a red **1**. Select **Chat**.
18. Under **Recent**, select **Abbi Skinner**.
19. In the **Type a new message** box, enter **Hello Abbi!**
20. Select the **Sticker** icon, and then select the **SuccessKid** sticker. Enter a **Top caption** and **Bottom caption**, and then select **Done**.
21. Select **Send**.
22. On **LON-CL2**, verify that **Abbi** received the chat.

> **Result**: After completing this exercise, you will have successfully:
>  - Configured Skype for Business Server 2015 and Skype for Business online.
>  - Configured Teams.
>  - Tested Skype for Business and Teams communications.



## Exercise 4: Enable Office 365 Phone System and Audio Conferencing
  
#### Task 1: Configure Audio Conferencing

1. On **LON-SFB**, verify that the **Microsoft Teams &amp; Skype for Business Admin Center** window is still open. If not, in the address bar, enter **https://admin.teams.microsoft.com/dashboard**.
2. Sign in as **Beth\@Adatumyyxxxxx.onmicrosoft.com**.
3. In the **Microsoft Teams &amp; Skype for Business Admin Center**, in the feature pane, expand **Meetings**, and then select **Conference bridges**.
4. In the results pane, review the Microsoft conference bridge phone numbers available for your tenant. Select the phone number listed as the **(default)** number.
5. To open the **Skype for Business admin center** in a new tab, in the left navigation pane, select **Legacy portal**.
6. In the **Skype for Business admin center**, in the left navigation pane, select **voice**, and then select the **phone numbers** tab.
7. Select **Add new number**, and then select **New service numbers**.
8. On the **Add new service numbers** page, select the following values, and then select **add**:

  - Country/Region: **United States**
  - State/Region: **Virginia**
  - City: **(703) Arlington**
  - Quantity: **1**

9. Select **show numbers**, make a note of the new service number, and then select **acquire numbers**.
10. Select the check box next to the new phone number, and then, in the right details pane, select **Assign**.
11. In the Assign pane, select the **Use this number as the default** check box, and then select **save**.
12. Switch back to the **Microsoft Teams &amp; Skype for Business Admin Center**, expand **Meetings**, and then select **Conference bridges**.
13. In the **Conference bridges** window, select the new **+1703** service number, and then select **Edit**.
14. In the properties pane for the service number, review the default language and alternate language options available for the conference bridge number. Change the second alternate language from **none** to **French (Canada)**, and then select **Save**.
15. In the left navigation pane, select **Meeting settings**, and then review the available settings for **Participants**, **Email invitation**, and **Network**.
16. Scroll down to **Select a port range for each type of real-time media traffic**, and then note the port range that is displayed for automatic mode.
17. Close Internet Explorer.

#### Task 2: Prepare for the next module
  
- When you are finished with the lab, keep all virtual machines running. The next lab/modules require the virtual machines in their current state.

> **Result**: After completing this exercise, you will have successfully added a new service number for audio conferencing.


©2018 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode "Creative Commons Attribution 3.0 License"), additional terms may apply. All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant. This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided "as-is." Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.

  
