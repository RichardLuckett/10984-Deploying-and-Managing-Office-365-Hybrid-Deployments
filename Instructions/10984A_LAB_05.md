# Module 5: Skype for Business hybrid deployment
# Lab: Implement the Skype for Business hybrid configuration
  
### Scenario
Adatum is continuing with their strategy to implement a hybrid Office 365 solution. You now need to implement Skype for Business Online in a hybrid configuration and evaluate Teams.

### Objectives
After completing this lab, you will be able to:

- Design and implement a Skype for Business hybrid environment.
- Move users to Skype for Business Online and verify functionality.

> **Note:** The lab steps for this course change frequently due to updates to Office 365, and Microsoft Learning updates the lab steps frequently. Therefore, they aren't available in this manual. Your instructor will provide you with the lab documentation.

### Lab setup
Estimated time: 120 minutes

Virtual machines: **10984A-LON-DC1**, **10984A-LON-DS1**, **10984A-LON-EX1**, **10984A-LON-SFB**, **10984A-LON-EDGE**, **10984A-LON-CL1**, and **10984A-LON-CL2**

Username: **Adatum\Administrator**

Password: **Pa55w.rd**

Virtual machine: **10984A-LON-WAP1**

Username: **LON-WAP1\Administrator**

Password: **Pa55w.rd**

This lab requires the completion of all prior labs (Lab 1 - Lab 4) before you begin. If the virtual machines are not running, you must complete the following step:

- Sign in to the virtual machines **10984A-LON-DC1**, **10984A-LON-DS1**, **10984A-LON-EX1**, **10984A-LON-WAP1**, **10984A-LON-SFB**, **10984A-LON-EDGE**, **10984A-LON-CL1**, and **10984A-LON-CL2** by using the following credentials.

  - Username: **Administrator**
  - Password: **Pa55w.rd**.

On **10984A-LON-SFB** and **10984A-LON-EDGE**, verify that the Skype for Business Server 2015 ISO image is mounted as drive **D**.

> **Note:** Please note, at the time of this course's development, Microsoft was rebranding the Office 365 Admin center. In most instances, the Office 365 Admin center now is called the Microsoft 365 admin center. However, you may encounter instances of Office 365 Admin center in this course, particularly in the user interface in labs. Don't assume you're in the wrong portal if you encounter instances of Office 365 Admin center. For this course, the two names refer to the same admin center.


## Exercise 1: Deploy Skype for Business with Enterprise Voice (pre-lab)
  
### Scenario
To prepare for Module 5, Lab A, Skype for Business Server 2015 will be deployed by using the custom domain provided to you (for example, Adatumyyxxxxx.hostdomain.com). Most of the preparation will be automated. You will need to run a series of scripts and provide information when prompted.

The main tasks for this exercise are as follows:

1. Prepare the environment (these steps have already been done for you)
2. Define topology (these steps have already been done for you)
3. Update the topology
4. Run deployment scripts


#### Task 1: Prepare the environment (these steps have already been done for you)

> **Note:** To save time, the steps in Task 1 and Task 2 have been completed for you. They are provided here for your information and future reference. You can proceed directly to **Task 3: Update Topology** to start this lab.


#### Task 2: Define topology (these steps have already been done for you)

> **Note:** To save time, the steps in Task 1 and Task 2 have been completed for you. They are provided here for your information and future reference. You can proceed directly to **Task 3: Update Topology** to start this lab.


#### Task 3: Update the topology
 
1. Sign in to **LON-SFB** as **Administrator@adatum.com** with the password **Pa55w.rd**.
2. Open File Explorer.
3. Browse to **C:\Labfiles\Mod05**.
4. Right-click **Lab5.txt**, select **Open with**, and then select **Notepad**.
5. In Notepad, select the **Edit** menu, and then select **Replace**.
6. In the **Replace** window, in the **Find what** box, enter **adatumyyxxxxx.hostdomain.com**. In the **Replace with** box, enter the name of the public domain you were assigned (for example, **AB12345.xtremelabs.us**), and then select **Replace All**.
7. Close the **Replace** window.
8. In the **Lab5.txt - Notepad** window, select the **File** menu, and then select **Save As**.
9. Save the file name as **Lab5.tbxml**, change the **Save as type** to **All files (\*.\*)**, and then select **Save**.

    > **Note:** Be careful not to leave a .txt extension on the filename.

10. When the **Confirm Save As** dialog box appears, select **Yes**.
11. Close Notepad.
12. On the taskbar, select **Skype for Business Server Topology Builder**.
13. In the **Topology Builder** window, select **Open Topology from a local file**, and then select **OK**.
14. Browse to **C:\Labfiles\Mod05**, select **Lab5.tbxml**, and then select **Open**.
15. In the **Skype for Business Server 2015 Topology Builder** window, review the following settings and verify that the domain name provided to you has been accurately applied to the topology builder file:

  - **SIP Domain**
  - **Simple URLs**
  - **Skype for Business Server 2015** &gt; **Standard Edition** &gt; **Front End Servers** &gt; **lon-sfb.adatum.com** &gt; **External web services**
  - **Edge pools** &gt; **lon-edge.adatum.com** &gt; **External settings**

    > **Note:** The expected result is that your assigned adatumyyxxxxx.hostdomain.com has replaced the placeholder values.

    > Be aware that a Skype for Business Server 2015 Standard Edition server's internal Fully Qualified Domain Names (FQDNs) must match its Active Directory Domain (AD DS) FQDN. This is different from the Enterprise Edition pool FQDN. In this lab, that means that the pool FQDN must be **lon-sfb.adatum.com**. The internal FQDN of **LON-EDGE** is also **lon-edge.adatum.com**.

    > If you see any discrepancies or have any concerns about the settings, please let your instructor know before continuing.

    > If everything looks okay, you are ready to continue to the next step and publish the topology.

16. Right-click **Adatum**, select **Topology**, and then select **Publish**.
17. On the **Publish the topology** page, select **Next**.
18. On the **Select Central Management Server** page, verify that **lon-sfb.adatum.com Adatum** is selected, and then select **Next**.

    > **Note:** The expected results are that all publishing steps have a **Success** status.

19. On the **Publishing wizard complete** page, select **Finish**.
20. Close the **Skype for Business Server 2015**, **Topology Builder** window.


#### Task 4: Run deployment scripts
  

1. Sign in to **LON-SFB** as **Administrator@adatum.com** with the password **Pa55w.rd**.
2. Open File Explorer.
3. Browse to **C:\Labfiles\Mod05**.
4. Right-click **SfBSetup.txt**, select **Rename**, change **.txt** to **.ps1**, and then press **Y** to accept the change.
5. Right-click **SfBSetup.ps1**, and then select **Edit**.
6. In the **Windows PowerShell ISE** window, verify that the **SfBSetup.ps1** file is open.
7. At the **Windows PowerShell** command prompt, enter the following cmdlet, and then press Enter:

    ```
    Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force
    ```

8. In the **Windows PowerShell ISE** window, on the toolbar, select **Run Script**.
9. When prompted, enter **adatumyyxxxxx.hostdomain.com**, substituting your assigned domain name, and then press Enter.
10. At the **Windows PowerShell** prompt, verify the name you entered, and then press **Y** or select **Yes**.
11. Open File Explorer, browse to drive **D**, confirm that the Skype for Business Server 2015 **Setup**, **Support** and **autorun.inf** objects are visible, and then close File Explorer.
12. To allow the script to continue, in the **Windows PowerShell ISE** window, press Enter.

    > **Note:** Do not stop or pause the script. The script will continue to run.
    > It will take approximately 25 minutes for the script to complete. Continue with Exercise 2, and return to the **Windows PowerShell ISE** window after completing Exercise 2, Task 1 and Task 2.

13. After the script completes, press Enter to restart **LON-SFB**.
14. Sign in to **LON-SFB** as **Adatum\Administrator** with the password **Pa55w.rd**.
15. Sign in to **LON-DC1** as **Adatum\Administrator** with the password **Pa55w.rd**.
16. Open Windows PowerShell, enter the following command, and then press Enter.

    ```
    Restart-Service CertSvc
    ```

17. Close Windows PowerShell.
18. Sign in to **LON-EDGE** as **LON-EDGE\Administrator** with the password **Pa55w.rd**.
19. Open File Explorer and browse to **C:\Labfiles\Mod05**.
20. Right-click **EDGESetup.txt**, and then select **Rename**. Change **.txt** to **.ps1**, and then press **Y** to accept the change.
21. Right-click **EDGESetup.ps1**, and then select **Edit**.
22. In the **Windows PowerShell ISE** window, verify that the **EDGESetup.ps1** file is open.
23. At the **Windows PowerShell** command prompt, enter the following cmdlet, and then press Enter:

    ```
    Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force
    ```

24. In the **Windows PowerShell ISE** window, on the toolbar, select **Run Script**.
25. Open File Explorer and browse to drive **D**, confirm that the Skype for Business Server 2015 **Setup**, **Support** and **autorun.inf** objects are visible, and then close File Explorer.
26. To allow the script to continue, in the **Windows PowerShell ISE** window, press Enter.

    > **Note:** Do not stop or pause the script. The script will continue to run, and will take approximately 10 minutes to complete.

    >**Note:** If the script generates an error that the LON-DC1.adatum.com\AdatumCA could not be accessed and the Request-CsCertificate cmdlet fails, do the following and then run the script again:

    >1. Open Command Prompt and run **Ping LON-DC1.adatum.com** (confirm this fails).

    >2. Add **10.0.0.4  LON-DC1.adatum.com** entry to the Hosts file on LON-EDGE.

    >3. Run **ipconfig/flushdns**.

27. After the script completes, press Enter to restart **LON-EDGE**.
28. Sign in to **LON-EDGE** as **LON-EDGE\Administrator** with the password **Pa55w.rd**.

> **Result:** After completing this exercise, you will have prepared the lab environment for the remainder of Lab 5.


## Exercise 2: Design and implement a Skype for Business hybrid configuration
  
### Scenario
Adatum currently has the following Exchange Server servers deployed:

Atlanta site (6,000 users):

- **atl-pool.adatum.com**
- **ATL-FE1** (Skype for Business Front End - Enterprise Edition)
- **ATL-FE2** (Skype for Business Front End - Enterprise Edition)
- **ATL-FE3** (Skype for Business Front End - Enterprise Edition)
- **ATL-BE1** (SQL Server 2016)

London site (1,500 users):

- **LON-SE1** (Standard Edition Server)
- **LON-SE2** (Standard Edition Server)

**Additionally, the following information is available:**

- The London site and Atlanta site are both connected to the internet.
- Network load balancers are used to distribute connections to the three servers in the atl-pool.adatum.com Front End pool.
- **Lyncdiscoverinternal** resolves to atl-pool.adatum.com.
- You have an Office 365 Enterprise E3 trial subscription for 25 pilot users.
- Your manager asks you to evaluate Microsoft Teams.
- Mailbox migration is 50 percent complete. Approximately half of the users from each site still have mailboxes on-premises.
- Azure AD Connect was deployed to support the Exchange hybrid configuration.
- Enterprise Voice has been deployed, but only the users in London are enabled for it. 
- The London IP-PBX is already integrated with Enterprise Voice and users can make and receive phone calls by using their Skype for Business clients.
- Users in Atlanta use a legacy TDM-PBX and proprietary phones for PSTN connectivity. Atlanta users cannot use their Skype for Business clients to make calls to the PSTN.

**You have the following requirements:**

- Atlanta users must be able to make phone calls to any outside phone number by using their Skype for Business client.
- Users in the Research department in Atlanta must be able to communicate with a line of business applications that use XMPP for instant messaging and presence.
- The pilot users for Teams must be able to place calls through their on-premises IP-PBX.
- The world-wide sales organization for Adatum wants to leverage call queues. All sales representatives must be agents in at least one call queue.
- If the Atlanta site goes down, Atlanta users must be able to continue to communicate by using their Skype for Business clients.

The main tasks for this exercise are as follows:

1. Read and analyze the scenario requirements
2. Design and discuss a solution with the class
3. Configure Enterprise Voice
4. Deploy a Skype for Business hybrid configuration


#### Task 1: Read and analyze the scenario requirements

1. Read the exercise scenario and analyze the requirements from an integration perspective.
2. Identify the configurations that are necessary to satisfy the requirements.
3. Sign in to **LON-CL1** as **Adatum\Beth** with the password **Pa55w.rd**.
4. Open File Explorer, browse to **C:\Labfiles\Mod05**, and then open **10984_Lab5_Design.pptx**.
5. Use the PowerPoint slides to help you document your design.


#### Task 2: Design and discuss a solution with the class
Use the questions below to help refine your solution.

- **Question 1**: What components do you need to install and configure to satisfy the requirements?
- **Question 2**: What are the licensing requirements for Skype for Business Online?
- **Question 3**: When moving users to Skype for Business Online, what precautions should Adatum take based on their existing environment?
- **Question 4**: Which hybrid voice solution will work best for Adatum?
- **Question 5**: What would be different if Adatum were running only Lync Server 2010 and not Skype for Business Server 2015 on-premises?


#### Task 3: Configure Enterprise Voice

1. Sign in to **LON-SFB** as **Adatum\Administrator** with the password **Pa55w.rd**.
2. Open Skype for Business Server Control Panel and sign in as **Adatum\Administrator** with the password **Pa55w.rd**.
3. In the left navigation pane, select **Voice Routing**, and then select the **DIAL PLAN** tab.
4. Select **New**, and then select **User dial plan**.

    > **Note:** While a site-level dial plan might be preferable for an Enterprise Voice deployment, user-level dial plans are preferable in a hybrid configuration.

5. In the **Name** box, enter **London**.
6. In the **Simple name** box, enter **London**.
7. In the **Description** box, enter **London Dial Plan**.
8. In the **Dial-in conferencing region** box, enter **UK**.
9. In the **Associated Normalization Rules** section, select **Keep All**, and then select **Remove**.
10. Under **Associated Normalization Rules**, select **New**.
11. On the **New Normalization Rule** page, in the **Name** box, enter **London PBX Extensions [5 digits]**.
12. In the **Description** box, enter **5 digit PBX extensions to E.164**.
13. In the **Starting Digits** box, enter **950**.
14. In the **Length** drop-down list, select **Exactly**.
15. In the **Length** box, enter or select **5**.
16. In the **Digits to remove** box, enter or select **0**.
17. In the **Digits to add** box, enter **+4420790**.
18. In the **Dialed number to test** box, enter **95011**, and then select **Go**.
19. Verify that **+442079095011** displays next to **Normalized number**.
20. Select **OK** to close the **New Normalization Rule** page.
21. Under **Associated Normalization Rules**, select **New**.
22. On the **New Normalization Rule** page, in the **Name** box, enter **London SfB Extensions [5 digits]**.
23. In the **Description** box, enter **5 digit SfB extensions to E.164**.
24. In the **Starting Digits** box, enter **123**.
25. In the **Length** drop-down list, select **Exactly**.
26. In the **Length** box, enter or select **5**.
27. In the **Digits to remove** box, enter or select **0**.
28. In the **Digits to add** box, enter **+4420793**.
29. In the **Dialed number to test** box, enter **12301**, and then select **Go**.
30. Verify that **+442079312301** displays next to **Normalized number**.
31. Select **OK** to close the **New Normalization Rule** page.
32. Under **Associated Normalization Rules**, select **New**.
33. On the **New Normalization Rule** page, in the **Name** box, enter **UK National Numbers**.
34. In the **Description** box, enter **UK National numbers to E.164**.
35. In the **Build a Normalization Rule** box, select **Edit**.
36. In the **Match this pattern** box, replace the existing value with:

    ```
    ^0((1224|1268|28|121|1254|1253|1204|1202|1274|1273|20)(\d+))
    ```

37. In the **Translation Rule** box, replace the existing value with **+44$1**, and then select **OK**.
38. In the **Dialed number to test** box, enter **01224123456**, and then select **Go**.
39. Verify that **+441224123456** displays next to **Normalized number**.
40. Select **OK** to close the **New Normalization Rule** page.
41. Under **Associated Normalization Rules**, select **New**.
42. On the **New Normalization Rule** page, in the **Name** box, enter **UK International Numbers**.
43. In the **Description** box, enter **UK International numbers to E.164**.
44. In the **Starting Digits** box, type **00**.
45. In the **Length** drop-down list, select **At Least**.
46. In the **Length** box, enter or select **5**.
47. In the **Digits to remove** box, enter or select **2**.
48. In the **Digits to add** box, enter **+**.
49. In the **Dialed number to test** box, enter **0031205002500**, and then select **Go**.
50. Verify that **+31205002500** displays next to **Normalized number**.
51. Select **OK** to close the **New Normalization Rule** page.
52. Under **Associated Normalization Rules**, select **New**.
53. On the **New Normalization Rule** page, in the **Name** box, enter **London Service Numbers**.
54. In the **Description** box, enter **London Service numbers to E.164**.
55. In the **Build a Normalization Rule** box, select **Edit**.
56. In the **Match this pattern** box, replace the existing value with:

    ```
    ^((118)(\d{3}))$
    ```

57. In the **Translation Rule** box, replace the existing value with **+$1**, and then select **OK**.
58. In the **Dialed number to test** box, enter **118212**, and then select **Go**.
59. Verify that **+118212** displays next to **Normalized number**.
60. Select **OK** to close the **New Normalization Rule** page.
61. Select **OK** to close the **New Dial Plan** page.
62. On the **Dial Plan** page, select **Commit**, select **Commit all**.
63. In the **Uncommitted Voice Configuration Settings**, review the changes, and then select **OK**.
64. Verify the dial plans were successfully published, and then select **Close**.
65. In the **Skype for Business Server 2015 Control Panel**, on the **DIAL PLAN** tab, double-click **Global**.
66. In the **Associated Normalization Rules** window, select **Keep All**, and then select **Remove**.
67. Under **Associated Normalization Rules**, select **New**.
68. On the **New Normalization Rule** page, in the **Name** box, enter **All digit Inbound to E.164**.
69. In the **Description** box, enter **Catch All to E.164**.
70. In the **Starting Digits** box, don't enter anything.
71. In the **Length** drop-down list, select **Any**.
72. In the **Digits to remove** box, enter or select **0**.
73. In the **Digits to add** box, enter **+**, and then select **OK**.
74. Select **OK** to close the **Edit Dial Plan - Global** page.
75. Select **Commit**, select **Commit All**, and then select **OK**.
76. Close the **Skype for Business Server 2015 Control Panel** dialog box.
77. In the **Skype for Business Server 2015 Control Panel**, select **Voice Routing**, select **ROUTE**, and then select **New**.
78. On the **New Voice Route** page, use the following information to configure the route.

  - Name: **London PBX**
  - Description: **Route to London PBX**

79. In the **Starting digits for numbers that you want to allow** box, enter **+4420790**, and then select **Add**.
80. Verify that the **Match this Pattern** box displays **^\\+4420790**.
81. Verify that **Suppress caller ID** is not selected.
82. Next to the **Associated Trunks** list field, select **Add**.
83. In the **Select Trunk** window, select **PstnGateway:172.16.0.210 Adatum**, and then select **OK**.
84. In the **Associated PSTN Usages** window, select **select **.
85. In the **Select PSTN Usage Record** window, select **Local**, and then select **OK**.
86. Under **Translated Number to test**, enter **+442079095011**, and then select **Go**.
87. Verify that the test result shows **Matches the regular expression that you built**, and then select **OK**.
88. On the **Route** page, select **Commit**, select **Commit all**, and then select **OK**.
89. In the **Uncommitted Voice Configuration Settings**, review the changes, and then select **OK**.
90. Verify that the routes were successfully published, and then select **Close**.
91. In the **Skype for Business Server 2015 Control Panel**, select **Voice Routing**, and then select **VOICE POLICY**.
92. On the **Voice Policy** tab, select **New**, and then select **User Policy**.
93. In the **Name** box, enter **London Voice Policy**.
94. In the **Description** box, enter **London User Voice Policy**.
95. Under **Calling Features**, leave all the default calling features:

    | **Feature** | **Option** |
    | ------------------------------------- | --------- |
    |Enable Call Forwarding | Selected |
    | Enable Team Call | Selected |
    | Enable Delegation | Selected |
    | Enable PSTN Reroute | Selected |
    | Enable Call Transfer | Selected |
    | Enable Bandwidth Policy Override | Cleared |
    | Enable Call Park | Cleared |
    | Enable Malicious call tracing | Cleared |
    | Enable Simultaneous ringing of phones | Selected |

96. Under **Associated PSTN Usages**, select **New**.
97. On the **New PSTN Usage Record** page, enter **London PBX Extensions**.
98. Under **Associated Routes**, select **select **, select **London PBX**, and then select **OK**.
99. Select **OK** to close the **New PSTN Usage Record** window.
100. Scroll down and verify that **Call forwarding and simultaneous ringing PSTN Usages** is set to **Route using the call PSTN usages**.
101. Under **Translated number to test**, enter **+442079095011**, and then select **Go**.
102. Verify that the **Match this PSTN usage record** box displays**London PBX Extensions** and the **Match this route pattern** box displays **London PBX**, and then select **OK**.
103. On the **Voice Policy** page, select **Commit**, select **Commit all**.
104. In the **Uncommitted Voice Configuration Settings**, review the changes, and then select **OK**.
105. Verify that the voice policies were successfully published, and then select **Close**.
106. In Skype for Business Server 2015 Control Panel, select **Voice Routing**, and then select **TRUNK CONFIGURATION**.
107. Select **New**, and then select **Pool Trunk**.
108. In the **Select a Service** window, select **PstnGateway:172.16.0.210 - Adatum**, and then select **OK**.
109. In the **New Trunk Configuration - PstnGateway:172.16.0.210** window, under**Description**, enter **London PBX Trunk configuration**.
110. Verify that **Maximum Early Dialogs Supported** is set to **20**.
111. Change **Encryption support level** to **Optional**.
112. Verify that **Refer Support** is set to **Enable Sending Refer to the Gateway**.
113. Verify that **Enable media bypass** is not selected.
114. Verify that **Centralized media processing** is selected.
115. Verify that **Enable RTP Latching** is not selected.
116. Verify that **Enable forward call history** is not selected.
117. Verify that **Enable forward P-asserted Identity data** is not selected.
118. Verify that **Enable outbound routing failover timer** is selected.
119. In the **Associated translation rules, Called Number translation rules** window, select **New**.
120. In the **New Trunk Configuration â–º New Called Number Translation Rule** window, in the **Name** box, enter **London - e.164 to 5 digit internal extension**.
121. Under **Description**, enter **Translate the e.164 number to a 5 digit internal extension for London**.
122. In the **Build a Translation Rule** window, in the **Starting digits** box, enter **+442079**.
123. In the **Length** box, enter or select **Exactly** and**13**.
124. In the **Digits to Remove** box, enter or select **8**.
125. Verify that the **Digits to Add** box is empty, and then select **OK**.
126. In the **New Trunk Configuration - PstnGateway172.16.0.210** window, under **Phone Number to Test**, enter **+442079095011**, select **Called Number**, and then select **Go**.
127. Verify that the **Translation rule** box displays **95011**, the **Rule to Match** box displays **London - e.164 to 5 digit internal extension**, and then select **OK**.
128. On the **Trunk Configuration** page, select **Commit**, select **Commit all**.
129. In the **Uncommitted Voice Configuration Settings**, review the changes, and then select **OK**.
130. Verify that the routes were successfully published, and then select **Close**.
131. In the left navigation pane, select **Users**.
132. On the **USER SEARCH** page, select **Enable users**, and under **New Skype for Business Server User**, select **Add**.
133. In the **Search** box, enter **Holly**, and then select **Find**.
134. Select **Holly Spencer**, and then select **OK**.
135. In the **Assign users to a pool** drop-down box, select **lon-sfb.adatum.com**.
136. Under **Generate user's SIP URI**, select **Use the user principal name (UPN)**.
137. In the **Telephony** drop-down box, select **Enterprise Voice**.
138. In the **Line URI** box, enter **tel:+442079312380**.
139. In the **Dial plan policy** drop-down box, select **London**.
140. In the **Voice policy** drop-down box, select **London Voice Policy**.
141. On the **USER SEARCH** page, select **Enable**.
142. Repeat steps 132 -141 to enable the following users for Skype for Business with Enterprise Voice by using the Line URI provided for each user.

    |  **User** | **Line URI** |
    | ------------- | ------------------- |
    | Adam Hobbs | tel:+442079312341 |
    | Beth Burke | tel:+442079312335 |
    | Abbi Skinner | tel:+442079312310 |
    | Allan Yoo | tel:+442079312320 |
    | Cai Chu | tel:+442079312383 |
    | Ella Perry | tel:+442079312372 |
    | Jon Friday | tel:+442079312308 |

143. In the left navigation pane, select **Federation and External Access**, and then select the **EXTERNAL ACCESS POLICY** tab.
144. On the **EXTERNAL ACCESS POLICY** tab, review the settings for the **Global** policy. Note that there no external access options enabled.
145. Select the **ACCESS EDGE CONFIGURATION** tab and review the settings for the **Global** policy. Note that no external access options are enabled.
146. Select **SIP FEDERATED DOMAINS**, and then verify that there are no **Allowed or Blocked** domains configured.
147. Sign in to **LON-DS1** as **Adatum\Administrator** with the password **Pa55w.rd**.
148. Open Windows PowerShell.
149. In the **Windows PowerShell** window, enter the following cmdlet, and then press Enter:

    ```
    Start-ADSyncSyncCycle -PolicyType Initial
    ```


#### Task 4: Deploy a Skype for Business hybrid configuration

1. On **LON-SFB**, open File Explorer, browse to **C:\LabFiles\Mod05**, and then double-click **msoidcli_64bit.msi**.
2. Install the Microsoft Online Services Sign-in Assistant by using the default settings, and then select **Finish**.
3. On the taskbar, select **Skype for Business Server Management Shell**.
4. At the **Skype for Business Server Management Shell** command prompt, enter the following command, and then press Enter:

    ```
    Install-Module MSOnline
    ```

5. In the **NuGet provider is required to continue** box, enter **Y**, and then press Enter.
6. In the **Untrusted Repository** box, enter **Y**, and then press Enter.
7. At the **Skype for Business Server Management Shell** command prompt, enter the following command, and then press Enter:

    ```
    Set-CSAccessEdgeConfiguration -AllowOutsideUsers 1 -AllowFederatedUsers 1 -EnablePartnerDiscovery 1 -UseDnsSrvRouting -AllowAnonymousUsers 1
    ```

8. Enter the following command, and then press Enter:

    ```
    Set-CsExternalAccessPolicy -EnableFederationAccess 1 -EnablePublicCloudAccess 1 -EnableOutsideAccess 1
    ```

9. Enter the following command, and then press Enter:

    ```
    Get-CsHostingProvider | Remove-CsHostingProvider
    ```

    > **Note:** This will remove any existing hosting provider to create a clean environment for the lab.

10. Enter the following command, and then press Enter:

    ```
    New-CSHostingProvider -Identity SkypeforBusinessOnline -ProxyFqdn sipfed.online.lync.com -Enabled $true -EnabledSharedAddressSpace $true -HostsOCSUsers $true -VerificationLevel UseSourceVerification -IsLocal $false -AutodiscoverUrl https://webdir.online.lync.com/Autodiscover/AutodiscoverService.svc/root
    ```

11. Enter the following command, and then press Enter:

    ```
    $creds=Get-Credential
    ```

12. When prompted, enter your Office 365 lab tenant administrator account username and password. For example, Beth@adatumyyxxxxx.onmicrosoft.com.
13. Enter the following command, and then press Enter:

    ```
    Import-Module SkypeOnlineConnector
    ```

    > **Note:** You can safely ignore the warnings about WSMan NetworkDelayms.

14. Enter the following command, and then press Enter:

    ```
    $CSSession = New-CsOnlineSession -Credential $creds
    ```

15. Enter the following command, and then press Enter:

    ```
    Import-PSSession $CSSession -AllowClobber
    ```

16. Enter the following command, and then press Enter:

    ```
    Set-CsTenantFederationConfiguration -SharedSipAddressSpace $True
    ```

17. Close the **Skype for Business Server Management Shell** command prompt.

    > **Note:** You should have now configured the environment in preparation for moving on-premises Skype for Business users to Skype for Business Online.

18. Open the **Skype for Business Server 2015 Control Panel**.
19. In the left navigation pane, select **Home**.
20. Under **Connection to Skype for Business Online**, select **Sign in to Office 365**.
21. Sign in to **Office 365** by using the Office 365 tenant administrator's credentials. For example, Beth@adatumyyxxxxx.onmicrosoft.com. Use the password you created in Lab 1.
22. After the message **you have successfully signed in to Office 365** appears, select **Close**.
23. Under **Connection to Skype for Business Online**, select **Set up hybrid with Skype for Business Online**.

    > **Note:** We are running the **Set up hybrid with Skype for Business Online Wizard** to confirm that all the PowerShell cmdlets worked correctly.

24. On the **Set up Hybrid with Skype for Business Online** page, select **Next**.
25. If any red **X**s appear, then something expected is missing in the hybrid configuration.
26. Select **Next** to allow the wizard to configure the missing setting (or settings).
27. Confirm that green check marks appear next to all four hybrid configuration settings and select **Close**.

    > **Note:** Leave the Skype for Business Server 2015 Control Panel open. You will need it in the next exercise.


> **Result**: After completing this exercise, you will have successfully:
>  - Read and analyzed the scenario requirements.
>  - Designed a solution.


## Exercise 3: Move users to Skype for Business Online
  
### Scenario
  Before moving users to Skype for Business online, you need to deploy a hybrid configuration.


The main tasks for this exercise are as follows:

1. Move users to Skype for Business Online
2. Configure Microsoft Teams for your Office 365 tenant
3. Verify communications between users on Skype for Business Server and users on Skype for business Online
4. Verify communications between users on Skype for Business and Teams


#### Task 1: Move users to Skype for Business Online

1. Sign in to **LON-CL1** as**Adatum\Adam** with the password **Pa55w.rd**.
2.  select **Start**, enter **Skype**, and then select **Skype for Business 2016**.
3. In the **First things first** window, select **Ask me later**, and then select **Accept**.
4. Close the **Welcome** page.
5. If the Microsoft Office Activation Wizard window appears, Click **Close**.
6. Confirm that **Adam Hobbs** is signed in.
7. In the **Find** box, enter **abbi@adatumyyxxxxx.hostdomain.com**, and then confirm that **Abbi Skinner** resolves on the **MY CONTACTS** tab.
8. Right-click **Abbi Skinner**, and then select **Add to Favorites**.
9. Sign in to **LON-CL2** as **Adatum\Abbi** with the password **Moc10984A**.
10.  select **Start**, enter **Skype**, and then select **Skype for Business 2016**.
11. In the **First things first** window, select **Ask me later**, and then select **Accept**.
12. Close the **Welcome** page.
13. If the Microsoft Office Activation Wizard window appears, Click **Close**.
14. Confirm that **Abbi Skinner** is signed in.
15. In the **Find** box, enter **adam@adatumyyxxxxx.hostdomain.com**, and then confirm that **Adam Hobbs** resolves on the **MY CONTACTS** tab.
16. Right-click **Adam Hobbs**, and then select **Add to Favorites**.
17. On **LON-SFB**, open Internet Explorer.
18. In the address bar, enter **https://portal.office.com/adminportal/home**, and then press Enter.
19. Sign in as **Beth@adataumyyxxxxx.onmicrosoft.com** with the password you created in Module 1.

    >**Note:** If the icons do not appear correctly in the Microsoft 365 admin center, add **https://portal.office.com** to the Trusted Sites for Internet Explorer and refresh the window. 

    > **Note:** Steps 20-24 should have been completed as part of the Module 04 Lab. After you confirm that Adam, Abbi, Allan, Cai, Ella, and Jon have been assigned Office 365 Enterprise E5 licenses, you can skip to step 25.

20. Click **Admin**, and then select **Users**. Select **Active Users**, and then select the check boxes for the following user accounts:

  - **Adam Hobbs**
  - **Abbi Skinner**
  - **Allan Yoo**
  - **Cai Chu**
  - **Ella Perry**
  - **Jon Friday**

21. Under **Bulk actions**, in the right pane, select **Edit product licenses**.
22. Under **Assign products**, select **Add to existing product license assignments**, and then select **Next**.
23. Under **location**, select **United States**, assign the **Office 365 Enterprise E5** licenses by changing the switch from **Off** to **On**, and then select **Add**.
24. Confirm that six licenses were assigned, and then select **Close**.
25. Restore the **Skype for Business Server 2015 Control Panel** window.
26. In the left navigation pane, select **Home**. Under **Connection to Skype for Business Online**, verify that you are still signed in to Office 365 with tenant credentials.
27. In the **Skype for Business Control Panel** window, in the left navigation pane, select **Users**. On the **USER SEARCH** tab, select **Find**.
28. Verify that a list of all Skype for Business-enabled users displays.
29. Select **Adam Hobbs**, select **Action**, and then select **Move selected users to Skype for Business Online**.
30. In the **Move users to Skype for Business Online** Wizard, select **Next**.
31. If your credentials have expired, you will get a message that says **You're not signed into Office 365**. If this occurs, select **Sign in to Office 365**, and then sign in with your Microsoft Office 365 tenant credentials. For example, Beth@adatumyyxxxxx.onmicrosoft.com.
32. Use the password you created in Lab 1.
33. After you sign in, select **OK**, and then select **Close**.
34. In the **Move users to Skype for Business Online** Wizard, select **Next**.
35. When a message, "Do you want to move the selected users," appears, select **Next**.

    > **Note:** While the move is successful, the Skype for Business Server 2015 Edge (**LON-EDGE1**) does not have a public IP in this lab environment. This will prevent full hybrid communications for this lab.

    > **Note:** If the move failed with the error "**Cannot find user in Active Directory with the follwing SIP URI**", run **Start-ADSyncSyncCycle -PolicyType Initial** on **LON-DS1** and try again after sync completes. It can take 30 minutes or longer for an **On-premises (hybrid)** user, like Adam Hobbs, to appear in the **Microsoft Teams & Skype for Business Admin Center** after assigning the Office 365 Enterprise E5 license. Until provisioning completes, this error will persist.
 
36. Close the **Move users to Skype for Business Online** Wizard.


#### Task 2: Configure Microsoft Teams for your Office 365 tenant

1. Sign in to **LON-SFB** as**Adatum\Administrator** with the password **Pa55w.rd**.
2. Open Internet Explorer.
3. In the address bar, enter **https://admin.teams.microsoft.com/dashboard**, and then press **enter **.
4. Sign in as **Beth@Adatumyyxxxxx.onmicrosoft.com** with the password you created in Module 1.
5. In the left navigation pane, expand **Org-wide settings**, and then select **Teams upgrade**.
6. To see the upgrade options, on the **Teams upgrade** page, under **Coexistence mode**, select the drop-down arrow.
7. Select **Skype for Business Only**, and then select **Save**.

    > **Note:** A change at this level will impact all users in the organization by default.

8. In the left navigation pane, select **Users**, and then review the list of users that are already licensed for Teams.
9. Select the **Directory status** tab to sort the table by status, and note the user accounts that have the status of **Online (hybrid)**.

    > **Note:** Only Teams users that have the directory status of **Online (hybrid)** have full coexistence between their Skype for Business and Teams clients.

10. In the list of users, select **Adam Hobbs**.
11. On the **Adam Hobbs** page, in the **Teams upgrade** section, select **Edit**. (You might have to scroll down to see this section of the **Account** tab.)
12. In the Teams upgrade pane, in the **Coexistence mode** drop-down box, select **Islands**, and then select **Save**.
13. In the left navigation pane, select **Users**, and then, in the list of users, select **Abbi Skinner**.
14. On the **Abbi Skinner** page, in the **Teams upgrade** section, select **Edit**. (You might have to scroll down to see this section of the **Account** tab.)
15. In the Teams upgrade pane, in the **Coexistence mode** drop-down box, select **Islands**, and then select **Save**.
16. Under **Org-wide settings**, review the default settings for the **External access** and **Guest Access** tabs.
17. Keep the **Microsoft Teams &amp; Skype for Business Admin Center** window open, as you will use it later in this lab.


#### Task 3: Verify communications between users on Skype for Business Server and users on Skype for business Online

1. On **LON-CL1**, verify that you are still signed in as **Adam@Adatumyyxxxxx.hostdomain.com**.
2. Verify whether **Adam** is able to sign in automatically to Skype for Business Online after his account was moved.
3. If not, sign in to Skype for Business as **Adam@Adatumyyxxxxx.hostdomain.com** with the password **Pa55w.rd**.
4. On **LON-CL2**, verify you are still signed in as **Abbi@Adatumyyxxxxx.hostdomain.com** with the password **Pa55w.rd**.
5. Verify that **Abbi** is also still signed in to Skype for Business.
6. In the **Favorites** section, double-click **Adam Hobbs**.
7. In the IM window for Adam Hobbs, enter **Hello Adam**, and then select **Send**. Note the error that is returned.
8. On **LON-CL1**, restore the Skype for Business client.
9. In the **Favorites** section, double-click **Abbi Skinner**.
10. In the **IM** window for **Abbi Skinner**, enter **Hello Abbi**, and then select **Send**. Note the error that is returned.

    > **Note:** The IM communications between Adam and Abbi are not expected to work.

    > The **LON-EDGE** server does not have a public IP on the external interface in this lab environment. While there is internet access, it is from the internal network and the Web Application Proxy. This only provides limited functionality.

11. Close the **IM** window.


#### Task 4: Verify communications between users on Skype for Business and Teams

1. On **LON-CL2**, open Microsoft Edge.
2. In the address bar, enter **https://teams.microsoft.com**, and then press Enter.
3. Sign in as **Abbi@Adatumyyxxxxx.hostdomain.com** with the password **Moc10984A**. If prompted to stay signed in, select **Yes**. If prompted to save your password, select **No**.
4. Close the introduction pop-up window.
5. In the left pane, select **Chat**.
6. On the top of the **Teams** window, to the left of the **Search** box, select the **New Chat** icon.
7. In the **Search** box, enter **Adam**, and then, from the search results, select **Adam Hobbs**.
8. On the **Conversation** tab, in the **Type a new message** box, enter **Hello Adam!** and press Enter.
9. On **LON-CL1**, verify whether **Adam** received the chat message from **Abbi**.

    > **Note:** Adam should not receive the message in Skype for Business. Both Adam and Abbi are configured to use Islands coexistence. This option isolates the communications made between users so that they must use the same application to communicate with one another.

10. Open Microsoft Edge.
11. In the address bar, enter **https://teams.microsoft.com/downloads**, and then press Enter.
12. Under the **Desktop Apps in the Windows** tile, select **Download (64-bit)**.
13. When prompted, select **Save As**, browse to **C:\Labfiles\Mod05**, and then select **Save**.
14. After the download completes, select **Run**.

    > **Note:** If the download times out, try to download it again. It might take a few attempts, but it should eventually download.
    > If a message displays that says This App can't be run on your PC, this can be addressed by either of the following two methods:
    >
    >  1. Open Microsoft Edge in **InPrivate** mode, and then download and run the application.
    >  2. In Microsoft Edge, under **Settings\View Advanced Settings**, turn off **Help protect me from malicious sites and downloads with Windows Defender SmartScreen**.

15. In the **Login to Microsoft Teams** window, confirm that Adam@Adatumyyxxxxx.hostdomain.com is the specified username. enter **Pa55w.rd** as the password, and then select **Sign in**. Note that at this point Adam is signed in to both Teams and Skype for Business desktop apps on **LON-CL1**.
16. If an additional window appears close it.

    > **Note:** The Teams desktop app is not included with an Office Pro Plus installation. However, you can download it from [https://teams.microsoft.com/downloads](https://teams.microsoft.com/downloads) for Windows, Mac, iOS, and Android.

17. In the left pane, note that **Chat** has a red **1**. Select **Chat**.
18. Under **Recent**, select **Abbi Skinner**.
19. In the **Type a new message** box, enter **Hello Abbi!**
20. Select the **Sticker** icon, and then select the **SuccessKid** sticker. Enter a **Top caption** and **Bottom caption**, and then select **Done**.
21. Select **Send**.
22. On **LON-CL2**, verify that **Abbi** received the chat.

> **Result**: After completing this exercise, you will have successfully:

- Configured Skype for Business Server 2015 and Skype for Business online.
- Configured Teams.
- Tested Skype for Business and Teams communications.


## Exercise 4: Enable Office 365 Phone System and Audio Conferencing
  
### Scenario
You need to review the **audio conferencing** settings and add a new service number for audio conferencing.

The main tasks for this exercise are as follows:

1. Configure Audio Conferencing
2. Prepare for the next module


#### Task 1: Configure Audio Conferencing

1. On **LON-SFB**, verify that the **Microsoft Teams &amp; Skype for Business Admin Center** window is still open. If not, in the address bar, enter **https://admin.teams.microsoft.com/dashboard**.
2. Sign in as **Beth@Adatumyyxxxxx.onmicrosoft.com**.
3. In the **Microsoft Teams &amp; Skype for Business Admin Center**, in the feature pane, expand **Meetings**, and then select **Conference bridges**.
4. In the results pane, review the Microsoft conference bridge phone numbers available for your tenant. Select the phone number listed as the **(default)** number.
5. To open the **Skype for Business admin center** in a new tab, in the left navigation pane, select **Legacy portal**.
6. In the **Skype for Business admin center**, in the left navigation pane, select **voice**, and then select the **phone numbers** tab.
7. Select **Add new number**, and then select **New service numbers**.
8. On the **Add new service numbers** page, select the following values, and then select **add**:

  - Country/Region: **United States**
  - State/Region: **Virginia**
  - City: **(703) Arlington**
  - Quantity: **1**

9. Select **show numbers**, make a note of the new service number, and then select **acquire numbers**.
10. Select the check box next to the new phone number, and then, in the right details pane, select **Assign**.
11. In the Assign pane, select the **Use this number as the default** check box, and then select **save**.
12. Switch back to the **Microsoft Teams &amp; Skype for Business Admin Center**, expand **Meetings**, and then select **Conference bridges**.
13. In the **Conference bridges** window, select the new **+1703** service number, and then select **Edit**.

    >**Note:** You may need to refresh the Internet Explorer browser window to see the new service number.

14. In the properties pane for the service number, review the default language and alternate language options available for the conference bridge number. Change the second alternate language from **none** to **French (Canada)**, and then select **Save**.
15. In the left navigation pane, select **Meeting settings**, and then review the available settings for **Participants**, **Email invitation**, and **Network**.
16. Scroll down to **Select a port range for each type of real-time media traffic**, and then note the port range that is displayed for automatic mode.
17. Close Internet Explorer.


#### Task 2: Prepare for the next module
  
- When you are finished with the lab, keep all virtual machines running. The next lab/module require the virtual machines in their current state.

> **Result**: After completing this exercise, you will have successfully added a new service number for audio conferencing.



### Review question(s)

**Question** 

When moving users from Skype for Business Server 2015 to Skype for Business Online, what should you do to prevent move errors?

**Question** 

Which coexistence mode will allow users to run both Skype for Business Clients and Teams?


©2018 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode "Creative Commons Attribution 3.0 License"), additional terms may apply. All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant. This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided "as-is." Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.

  
